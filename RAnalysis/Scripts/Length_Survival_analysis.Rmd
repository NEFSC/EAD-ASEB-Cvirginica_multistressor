---
title: "Regressions"
author: "Katie McFarland"
date: "7/23/2021"
output:
  pdf_document: default
  html_document: default
---

# load libraries

```{r, include=FALSE}

library(ggplot2)
library(dplyr)
library(tidyverse)
library(multcompView)
library(agricolae)
library(dplyr)
library(lme4)
library(ggplot2)
library(nlme)
library(car)
library(performance)
library(stargazer)
library(emmeans)
```


# Set Path & load data

```{r setup}
#Set Path

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
# raw data 
raw_length_dat_Age1    <- read.csv("Data/Length_Survival/timepoint_1_Day1.csv", header = T)
raw_length_dat_Age8    <- (read.csv("Data/Length_Survival/timepoint_2_Day8.csv", header = T) %>% dplyr::select(!X))[-51,] # row 51 has comments in the raw data file 
raw_length_dat_Age8    <- sapply(raw_length_dat_Age8, as.numeric)

# average data 
Av_length.survival_dat <- read.csv("Data/Length_Survival/LengthSurvival_master.csv", header = T) %>% 
                            dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = ''))
head(Av_length.survival_dat)
```


# prep data 

```{r, prep the raw data for stats} 
# extract the experiment data with coresponding sampke Ids from the averaged data master file...
Exp_data <-  Av_length.survival_dat %>% filter(Day %in% 1) %>% dplyr::select(c('Temp','OA','Salinity','Replicate','Id.', 'pH', 'AR')) %>% dplyr::rename(Sample.ID = Id., Aragonite_saturation = AR)

# melt the raw data, cean and format it for merging with Exp_data

# Age 1
raw_length_Age1MELT <- reshape2::melt(raw_length_dat_Age1) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age1_raw_length      <- merge(raw_length_Age1MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = ''))

# Age 1
raw_length_Age8MELT <- reshape2::melt(raw_length_dat_Age8) %>% 
                        na.omit() %>%  
                        dplyr::select(!Var1) %>% 
                        dplyr::rename(length_um = value , Sample.ID =Var2) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age8_raw_length  <- merge(raw_length_Age8MELT, Exp_data, by = 'Sample.ID')  %>% 
                          dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = ''))


```
 
 
 
 
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Length ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


### Age 24 hours ALL DATA ------------

```{r, LENGTH Age 24 hours size - all data}

# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1Length_lme_mod <- lme(length_um~OA*Temp*Salinity,random=~1|random_fact,data=Age1_raw_length)
knitr::kable(anova(Age1Length_lme_mod))

# numDF	denDF	F-value	p-value
# (Intercept)	1	1176	1.511572e+05	0.0000000
# OA	1	16	1.084246e+02	0.0000000
# Temp	1	16	1.860223e+01	0.0005359
# Salinity	1	16	1.204280e+02	0.0000000
# OA:Temp	1	16	1.363112e+00	0.2601038
# OA:Salinity	1	16	5.876202e+00	0.0275638
# Temp:Salinity	1	16	2.105428e+00	0.1661008
# OA:Temp:Salinity	1	16	1.134631e+00	0.3026011


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age1Length_lme_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # 0.2716 PASS
boxplot(residuals(Age1Length_lme_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age1Length_lme_mod)) # check for normality of residuals       


# post hoc tests --------------------------------------------------------------------------------------------------- #


require(emmeans)
emmeans(Age1Length_lme_mod, list(pairwise ~ OA:Salinity), adjust = "tukey") #posthoc

 # High High - Low High   -2.964 0.525 16  -5.649  0.0002
 # High High - High Low    4.971 0.525 16   9.474  <.0001
 # High High - Low Low     0.208 0.525 16   0.397  0.9781
 # Low High - High Low     7.935 0.525 16  15.123  <.0001
 # Low High - Low Low      3.172 0.525 16   6.046  0.0001
 # High Low - Low Low     -4.763 0.525 16  -9.077  <.0001

# notes on Tukey HSD (for the figure)
# pCO2 and salinity 
# High High a
# Low High  bc
# High Low d
# Low Low a


# plot the data  ----------------------------------------------------------------------------------------------------- #


Age1_ShellLength_Boxplot <- ggplot(data=Age1_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_classic() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Larvae size (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

# save the plot 
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_24hrs_Boxplots.pdf", width=8, height=6)
print(Age1_ShellLength_Boxplot)
dev.off()




# -------------------------------------------------------------------------------------------------------------------- #


# For the results section -  expand upon the mean sd and percent differences in the Tukey HSD 
Age1_Length_Table <- Age1_raw_length %>% 
                        dplyr::group_by(OA,Salinity) %>% 
                        dplyr::summarise(mean_length = mean(length_um),
                                         n = n(),
                                         sd_length = sd(length_um),
                                         se_length = sd_length/(sqrt(n)))

# how many animals were measured per replicate / per treatment?
Age1_raw_length %>% 
            dplyr::group_by(random_fact) %>% 
            dplyr::summarise(n = n())
```


### Age 24 hours HIGH TEMP ONLY ------------


```{r, LENGTH Age 24 hours - HIGH TEMP ONLY}
### Age 24 hours HIGH TEMP ONLY  ------------
# -------------------------------------------------------------------------------------------------------------------- #
# High temp only 

#data 
Age1_raw_length_hightemp <- Age1_raw_length %>% dplyr::filter(!Temp %in% 'Low')

# run model
Age1Length_lme_mod_hightemp <- lme(length_um~OA*Salinity,random=~1|random_fact,data=Age1_raw_length_hightemp) # notice temp is removed...
pander(anova(Age1Length_lme_mod_hightemp), style='rmarkdown') # anova table of lmer

# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  588  | 105297  |     0     |
# |     **OA**      |   1   |   8   |  58.24  | 6.121e-05 |
# |  **Salinity**   |   1   |   8   |  105.2  | 7.024e-06 |
# | **OA:Salinity** |   1   |   8   |  1.258  |  0.2945   |


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #

leveneTest(residuals(Age1Length_lme_mod_hightemp) ~Age1_raw_length_hightemp$OA*Age1_raw_length_hightemp$Salinity) # 0.4058 PASS
boxplot(residuals(Age1Length_lme_mod_hightemp) ~ Age1_raw_length_hightemp$OA*Age1_raw_length_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age1Length_lme_mod_hightemp)) # check for normality of residuals       





# high temp only
Age1_ShellLength_Boxplot_hightemp <- ggplot(data=Age1_raw_length_hightemp, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                                     y=length_um, 
                                                                     colour=fct_relevel(Salinity, c("Low", "High")))) +
                                      geom_boxplot() + 
                                      theme_classic() +  
                                      stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                      labs(title="Age = 24 hours (high temp only)", x ="pCO2 level", y = "Larvae size (μm)")+ 
                                      theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                      theme(axis.text=element_text(size=12)) 

# save the plot 
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_24hrs_Boxplots_hightemp.pdf", width=8, height=6)
print(Age1_ShellLength_Boxplot_hightemp)
dev.off()

```


### Age 8 days ALL DATA  ------------

```{r, LENGTH Age 8 days hours size - all data}


# Age 8 Length mod - all data -------------------------------------------------------------------------------------- #


Age8Length_lme_mod <- lme(length_um~OA*Salinity*Temp,random=~1|random_fact,data=Age8_raw_length)
pander(anova(Age8Length_lme_mod), style='rmarkdown') # anova table of lmer

# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   | 1050  |  2433   |     0     |
# |        **OA**        |   1   |  15   |  17.5   | 0.0008002 |
# |     **Salinity**     |   1   |  15   |  16.61  | 0.0009943 |
# |       **Temp**       |   1   |  15   |  5.035  |  0.04035  |
# |   **OA:Salinity**    |   1   |  15   | 0.9695  |  0.3404   |
# |     **OA:Temp**      |   1   |  15   |  7.119  |  0.01754  |
# |  **Salinity:Temp**   |   1   |  15   |  4.766  |  0.04532  |
# | **OA:Salinity:Temp** |   1   |  15   |  4.322  |  0.05518  |


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #

shapiro.test(residuals(Age8Length_lme_mod)) # 0.3748  normal
leveneTest(residuals(Age8Length_lme_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # < 2.2e-16 *** - did not pass
boxplot(residuals(Age8Length_lme_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age8Length_lme_mod)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #


require(emmeans)
emmeans(Age8Length_lme_mod, list(pairwise ~ OA:Temp), adjust = "tukey") #posthoc
emmeans(Age8Length_lme_mod, list(pairwise ~ Salinity:Temp), adjust = "tukey") #posthoc


# plot the data  ----------------------------------------------------------------------------------------------------- #


require(forcats)
Age8_ShellLength_Boxplot <- ggplot(data=Age8_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_bw() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 8 days", x ="pCO2 level", y = "Shell Length (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_8days_Boxplots.pdf", width=8, height=6)
print(Age8_ShellLength_Boxplot)
dev.off()

```


### Age 8 days HIGH TEMP ONLY ------------


```{r LENGTH Age 8 days hours size - HIGH TEMP ONLY}

# High temp only 

#data 
Age8_raw_length_hightemp <- Age8_raw_length %>% dplyr::filter(!Temp %in% 'Low')

# run model ( LME model)
Age8Length_lme_mod_hightemp <- lme(length_um~OA*Salinity,random=~1|random_fact,data=Age8_raw_length_hightemp) # notice temp is removed...
pander(anova(Age8Length_lme_mod_hightemp), style='rmarkdown') # anova table of lmer
# |     &nbsp;      | numDF | denDF | F-value | p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:--------:|
# | **(Intercept)** |   1   |  531  |  1176   |    0     |
# |     **OA**      |   1   |   7   |  19.48  | 0.003104 |
# |  **Salinity**   |   1   |   7   |  17.82  | 0.00393  |
# | **OA:Salinity** |   1   |   7   |  3.686  | 0.09635  |

# Levene's test and visuals of the residuals
leveneTest(residuals(Age8Length_lme_mod_hightemp) ~Age8_raw_length_hightemp$OA*Age8_raw_length_hightemp$Salinity) # 6.08e-12 *** no pass
boxplot(residuals(Age8Length_lme_mod_hightemp) ~ Age8_raw_length_hightemp$OA*Age8_raw_length_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age8Length_lme_mod_hightemp)) # check for normality of residuals       



# un lm model
Age8Length_lm_mod_hightemp <- lm(sqrt(length_um)~OA*Salinity,data=Age8_raw_length_hightemp) # notice temp is removed...
pander(anova(Age8Length_lm_mod_hightemp), style='rmarkdown') # anova table of lmer
# |     &nbsp;      | Df  | Sum Sq | Mean Sq | F value |  Pr(>F)   |
# |:---------------:|:---:|:------:|:-------:|:-------:|:---------:|
# |     **OA**      |  1  | 113332 | 113332  |  277.2  | 1.649e-50 |
# |  **Salinity**   |  1  | 101921 | 101921  |  249.3  | 2.008e-46 |
# | **OA:Salinity** |  1  | 20519  |  20519  |  50.19  | 4.392e-12 |
# |  **Residuals**  | 538 | 219948 |  408.8  |   NA    |    NA     |


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #

shapiro.test(Age8Length_lm_mod_hightemp) # 2.779e-12
leveneTest(residuals(Age8Length_lm_mod_hightemp) ~Age8_raw_length_hightemp$OA*Age8_raw_length_hightemp$Salinity) # 1.054e-08 *** *** no pass
boxplot(residuals(Age8Length_lme_mod_hightemp) ~ Age8_raw_length_hightemp$OA*Age8_raw_length_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age8Length_lme_mod_hightemp)) # check for normality of residuals       




# high temp only
Age8_ShellLength_Boxplot_hightemp <- ggplot(data=Age8_raw_length_hightemp, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                                     y=length_um, 
                                                                     colour=fct_relevel(Salinity, c("Low", "High")))) +
                                      geom_boxplot() + 
                                      theme_classic() +  
                                      stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                      labs(title="Age = 24 hours (high temp only)", x ="pCO2 level", y = "Larvae size (μm)")+ 
                                      theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                      theme(axis.text=element_text(size=12)) 

# save the plot 
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_8days_Boxplots_hightemp.pdf", width=8, height=6)
print(Age8_ShellLength_Boxplot_hightemp)
dev.off()


```




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Survival ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


### Age 24 hours ALL DATA ------------

```{r SURVIVAL Age 24 hours - all data}
age_1<- Av_length.survival_dat %>%
          filter(Day=="1")


# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_1)
pander(anova(Age1_Survival_lme_mod), style='rmarkdown') # anova table of lmer

# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  16   |  1835   |     0     |
# |        **OA**        |   1   |  16   |  10.28  | 0.005513  | *
# |     **Salinity**     |   1   |  16   |  1.647  |  0.2176   |
# |       **Temp**       |   1   |  16   |  22.72  | 0.0002102 | *
# |   **OA:Salinity**    |   1   |  16   |  7.528  |  0.01442  | *
# |     **OA:Temp**      |   1   |  16   |  2.487  |  0.1344   |
# |  **Salinity:Temp**   |   1   |  16   |  2.07   |  0.1695   |
# | **OA:Salinity:Temp** |   1   |  16   |  3.096  |  0.09758  |


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # 0.8279- pass
boxplot(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lme_mod)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-lsmeans(Age1_Survival_lme_mod, ~OA*Salinity, adjust="tukey")
posthoc<-emmeans(Age1_Survival_lme_mod, pairwise~OA*Salinity, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Salinity emmean     SE df lower.CL upper.CL .group
 # High Low       0.382 0.0215 16    0.336    0.427  a    
 # High High      0.468 0.0215 16    0.423    0.514   b   
 # Low  High      0.478 0.0215 16    0.433    0.524   b   
 # Low  Low       0.509 0.0215 16    0.464    0.555   b 



# plot the data  ----------------------------------------------------------------------------------------------------- #



Age1_Survival_Boxplot_2 <- age_1 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, 
                                                ymax = mean_surv + se_surv,
                                                fill = fct_relevel(Salinity, c("Low", "High"))), 
                                                width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_24hrs_MeanSE.pdf", width=8, height=6)
print(Age1_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age1_Survival_Boxplot <- ggplot(data=age_1, aes(x=AR, y=Survival, fill=Treatment)) +
                            geom_boxplot()+scale_fill_manual(values=c("darkorange3", "darkorange3","royalblue3", "royalblue3","orange2", "orange2","skyblue2", "skyblue2"))+
                            geom_jitter( width = 0.02) +
                            theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                            theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                            labs(title="Age =24 hours", x ="Aragonite Saturation State", y = "Survival (%)")+ 
                            theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                            theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_24hrs.pdf", width=8, height=6)
print(Age1_Survival_Boxplot)
dev.off()
```


### Age 24 hours HIGH TEMP ONLY ------------

```{r, SURVIVAL Age 24 hours - HIGH TEMP ONLY}
age_1_hightemp <- Av_length.survival_dat %>%
                      filter(Day=="1") %>% 
                      dplyr::filter(Temp %in% 'High')


# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1_Survival_lme_mod_hightemp <- lme(Survival~OA*Salinity,random=~1|random_fact,data=age_1_hightemp)
pander(anova(Age1_Survival_lme_mod_hightemp), style='rmarkdown') # anova table of lmer

# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |   8   |  2296   | 3.977e-11 |
# |     **OA**      |   1   |   8   |  23.18  |  0.00133  | * main effect of OA 
# |  **Salinity**   |   1   |   8   | 0.02447 |  0.8796   |
# | **OA:Salinity** |   1   |   8   | 0.9816  |  0.3508   |


Age1_Survival_lm_mod_hightemp <- lm(Survival~OA*Salinity,data=age_1_hightemp)
pander(anova(Age1_Survival_lm_mod_hightemp), style='rmarkdown') # anova table of lmer

# |     &nbsp;      | Df |  Sum Sq   |  Mean Sq  | F value | Pr(>F)  |
# |:---------------:|:--:|:---------:|:---------:|:-------:|:-------:|
# |     **OA**      | 1  |  0.03158  |  0.03158  |  23.18  | 0.00133 | * main effect of OA 
# |  **Salinity**   | 1  | 3.333e-05 | 3.333e-05 | 0.02447 | 0.8796  |
# | **OA:Salinity** | 1  | 0.001337  | 0.001337  | 0.9816  | 0.3508  |
# |  **Residuals**  | 8  |  0.0109   | 0.001362  |   NA    |   NA    |



# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age1_Survival_lme_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # 0.5608- pass
boxplot(residuals(Age1_Survival_lme_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lme_mod_hightemp)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-lsmeans(Age1_Survival_lme_mod_hightemp, ~OA, adjust="tukey")
posthoc<-emmeans(Age1_Survival_lme_mod_hightemp, pairwise~OA, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   emmean     SE df lower.CL upper.CL .group
 # High  0.459 0.0151  8    0.425    0.494  a    
 # Low   0.562 0.0151  8    0.527    0.597   b 



# plot the data  ----------------------------------------------------------------------------------------------------- #



Age1_Survival_Boxplot_2 <- age_1_hightemp %>% 
  dplyr::group_by(OA,Salinity) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High"))))+
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High"))), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, 
                                                ymax = mean_surv + se_surv,
                                                fill = fct_relevel(Salinity, c("Low", "High"))), 
                                                width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                                                axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0)) +
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_24hrs_MeanSE.pdf", width=8, height=6)
print(Age1_Survival_Boxplot_2)
dev.off()

```


### Age 8 days ALL DATA  ------------

```{r, SURVIVAL Age 8 days - all data}
age_8<- Av_length.survival_dat%>%
  filter(Day=="8")


# Age 8 Length mod - all data -------------------------------------------------------------------------------------- #


Age8_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_8)
knitr::kable(anova(Age8_Survival_lme_mod))

# 	numDF	denDF	F-value	p-value
# (Intercept)	1	14	35.8522871	0.0000332
# OA	1	14	0.6474869	0.4344654
# Salinity	1	14	11.3729912	0.0045564
# Temp	1	14	0.3131010	0.5846252
# OA:Salinity	1	14	0.0000578	0.9940392
# OA:Temp	1	14	0.5313363	0.4780633
# Salinity:Temp	1	14	0.0013027	0.9717174
# OA:Salinity:Temp	1	14	0.1058076	0.7497789


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # 0.5706 pass
boxplot(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # visual of residuals grouped
qqnorm(resid(Age8_Survival_lme_mod)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-lsmeans(Age8_Survival_lme_mod, ~OA*Salinity*Temp, adjust="tukey")
posthoc<-emmeans(Age8_Survival_lme_mod, pairwise~OA*Salinity*Temp, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
# $`emmeans of Salinity`
#  Salinity emmean     SE df lower.CL upper.CL
#  High     0.3775 0.0561 14    0.257    0.498
#  Low      0.0887 0.0684 14   -0.058    0.235


# plot the data  ----------------------------------------------------------------------------------------------------- #
Age8_Survival_Boxplot_2 <- age_8 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 8 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_8days_MeanSE.pdf", width=8, height=6)
print(Age8_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age8_Survival_Boxplot <- ggplot(data=age_8, aes(x=AR, y=Survival, fill=Treatment)) +
                                  geom_boxplot()+scale_fill_manual(values=c("darkorange3", "darkorange3","royalblue3", "royalblue3","orange2", "orange2","skyblue2", "skyblue2"))+
                                  geom_jitter( width = 0.02) +
                                  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                  labs(title="Age = 8 days", x ="Aragonite Saturation State", y = "Survival (%)")+ 
                                  theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                  theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_8days.pdf", width=8, height=6)
print(Age8_Survival_Boxplot)
dev.off()

```


### Age 8 days HIGH TEMP ONLY ------------

```{r, SURVIVAL Age 8 days - HIGH TEMP ONLY}
age_8_hightemp <- Av_length.survival_dat %>%
                      filter(Day=="8") %>% 
                      dplyr::filter(Temp %in% 'High')


# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age8_Survival_lme_mod_hightemp <- lme(Survival~OA*Salinity,random=~1|random_fact,data=age_8_hightemp)
pander(anova(Age8_Survival_lme_mod_hightemp), style='rmarkdown') # anova table of lmer

# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |   6   |  46.03  | 0.0005015 |
# |     **OA**      |   1   |   6   | 0.3174  |  0.5936   |
# |  **Salinity**   |   1   |   6   |  15.52  |  0.00763  | # main effect of salinity
# | **OA:Salinity** |   1   |   6   | 0.1175  |  0.7434   |



Age8_Survival_lm_mod_hightemp <- lm(Survival~OA*Salinity,data=age_8_hightemp)
pander(anova(Age8_Survival_lm_mod_hightemp), style='rmarkdown') # anova table of lmer

# |     &nbsp;      | Df |  Sum Sq  | Mean Sq  | F value | Pr(>F)  |
# |:---------------:|:--:|:--------:|:--------:|:-------:|:-------:|
# |     **OA**      | 1  | 0.00384  | 0.00384  | 0.3174  | 0.5936  |
# |  **Salinity**   | 1  |  0.1878  |  0.1878  |  15.52  | 0.00763 | # main effect of salinity
# | **OA:Salinity** | 1  | 0.001422 | 0.001422 | 0.1175  | 0.7434  |
# |  **Residuals**  | 6  |  0.0726  |  0.0121  |   NA    |   NA    |




# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age8_Survival_lme_mod_hightemp) ~ age_8_hightemp$OA*age_8_hightemp$Salinity) # 0.6261- pass
boxplot(residuals(Age8_Survival_lm_mod_hightemp) ~ age_8_hightemp$OA*age_8_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age8_Survival_lm_mod_hightemp)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-lsmeans(Age8_Survival_lme_mod_hightemp, ~Salinity, adjust="tukey")
posthoc<-emmeans(Age8_Survival_lme_mod_hightemp, pairwise~Salinity, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
# Salinity emmean     SE df lower.CL upper.CL .group
#  Low      0.0683 0.0635  6  -0.0871    0.224  a    
#  High     0.3483 0.0449  6   0.2384    0.458   b   



# plot the data  ----------------------------------------------------------------------------------------------------- #



Age8_Survival_Boxplot <- age_8_hightemp %>% 
  dplyr::group_by(OA,Salinity) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High"))))+
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High"))), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, 
                                                ymax = mean_surv + se_surv,
                                                fill = fct_relevel(Salinity, c("Low", "High"))), 
                                                width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 8 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                                                axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0)) +
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_24hrs_MeanSE.pdf", width=8, height=6)
print(Age8_Survival_Boxplot)
dev.off()

```


