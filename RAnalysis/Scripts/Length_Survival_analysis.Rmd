---
title: "Regressions"
author: "Katie McFarland"
date: "7/23/2021"
output:
  pdf_document: default
  html_document: default
---


```{r, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(multcompView)
library(agricolae)
library(dplyr)
library(lme4)
library(ggplot2)
library(nlme)
library(car)
library(performance)
library(stargazer)

# library(sjPlot)

```

## Set Path & load data
```{r setup}
#Set Path

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
# raw data 
raw_length_dat_Age1    <- read.csv("Data/Length_Survival/timepoint_1_Day1.csv", header = T)
raw_length_dat_Age8    <- (read.csv("Data/Length_Survival/timepoint_2_Day8.csv", header = T) %>% dplyr::select(!X))[-51,] # row 51 has comments in the raw data file 
raw_length_dat_Age8    <- sapply(raw_length_dat_Age8, as.numeric)

# average data 
Av_length.survival_dat <- read.csv("Data/Length_Survival/LengthSurvival_master.csv", header = T) %>% 
                            dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = ''))
head(Av_length.survival_dat)
```


# 
```{r, prep the raw data for stats} 
# extract the experiment data with coresponding sampke Ids from the averaged data master file...
Exp_data <-  Av_length.survival_dat %>% filter(Day %in% 1) %>% dplyr::select(c('Temp','OA','Salinity','Replicate','Id.', 'pH', 'AR')) %>% dplyr::rename(Sample.ID = Id., Aragonite_saturation = AR)

# melt the raw data, cean and format it for merging with Exp_data

# Age 1
raw_length_Age1MELT <- reshape2::melt(raw_length_dat_Age1) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age1_raw_length      <- merge(raw_length_Age1MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = ''))

# Age 1
raw_length_Age8MELT <- reshape2::melt(raw_length_dat_Age8) %>% 
                        na.omit() %>%  
                        dplyr::select(!Var1) %>% 
                        dplyr::rename(length_um = value , Sample.ID =Var2) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age8_raw_length  <- merge(raw_length_Age8MELT, Exp_data, by = 'Sample.ID')  %>% 
                          dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = ''))


```




#  Age 1 stats (all data) - LARVAE SIZE

```{r, Age 1 raw data Size stats}

# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1Length_lme_mod <- lme(length_um~OA*Temp*Salinity,random=~1|random_fact,data=Age1_raw_length)
knitr::kable(anova(Age1Length_lme_mod))

# numDF	denDF	F-value	p-value
# (Intercept)	1	1176	1.511572e+05	0.0000000
# OA	1	16	1.084246e+02	0.0000000
# Temp	1	16	1.860223e+01	0.0005359
# Salinity	1	16	1.204280e+02	0.0000000
# OA:Temp	1	16	1.363112e+00	0.2601038
# OA:Salinity	1	16	5.876202e+00	0.0275638
# Temp:Salinity	1	16	2.105428e+00	0.1661008
# OA:Temp:Salinity	1	16	1.134631e+00	0.3026011


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age1Length_lme_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # 0.2716 PASS
boxplot(residuals(Age1Length_lme_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age1Length_lme_mod)) # check for normality of residuals       


# post hoc tests --------------------------------------------------------------------------------------------------- #


require(emmeans)
emmeans(Age1Length_lme_mod, list(pairwise ~ OA:Salinity), adjust = "tukey") #posthoc

 # High High - Low High   -2.964 0.525 16  -5.649  0.0002
 # High High - High Low    4.971 0.525 16   9.474  <.0001
 # High High - Low Low     0.208 0.525 16   0.397  0.9781
 # Low High - High Low     7.935 0.525 16  15.123  <.0001
 # Low High - Low Low      3.172 0.525 16   6.046  0.0001
 # High Low - Low Low     -4.763 0.525 16  -9.077  <.0001

# notes on Tukey HSD (for the figure)
# pCO2 and salinity 
# High High a
# Low High  bc
# High Low d
# Low Low a


# plot the data  ----------------------------------------------------------------------------------------------------- #


Age1_ShellLength_Boxplot <- ggplot(data=Age1_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_classic() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Larvae size (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

# save the plot 
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_24hrs_Boxplots.pdf", width=8, height=6)
print(Age1_ShellLength_Boxplot)
dev.off()


# -------------------------------------------------------------------------------------------------------------------- #


# For the results section -  expand upon the mean sd and percent differences in the Tukey HSD 
Age1_Length_Table <- Age1_raw_length %>% 
                        dplyr::group_by(OA,Salinity) %>% 
                        dplyr::summarise(mean_length = mean(length_um),
                                         n = n(),
                                         sd_length = sd(length_um),
                                         se_length = sd_length/(sqrt(n)))

# how many animals were measured per replicate / per treatment?
Age1_raw_length %>% 
            dplyr::group_by(random_fact) %>% 
            dplyr::summarise(n = n())


```






#  Age 8 stats (raw data) - LENGTH
```{r, Age 8 raw data Size stats}


# Age 8 Length mod - all data -------------------------------------------------------------------------------------- #


Age8Length_lme_mod <- lme(length_um~OA*Salinity*Temp,random=~1|random_fact,data=Age8_raw_length)
knitr::kable(anova(Age8Length_lme_mod))

# numDF	denDF	F-value	p-value
# (Intercept)	1	1050	2432.5393199	0.0000000
# OA	1	15	17.4957925	0.0008002
# Salinity	1	15	16.6102860	0.0009943
# Temp	1	15	5.0352849	0.0403546
# OA:Salinity	1	15	0.9695073	0.3404198
# OA:Temp	1	15	7.1194866	0.0175400
# Salinity:Temp	1	15	4.7663219	0.0453249
# OA:Salinity:Temp	1	15	4.3224631	0.0551845


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age8Length_lme_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # < 2.2e-16 *** - did not pass
boxplot(residuals(Age8Length_lme_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age8Length_lme_mod)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #


require(emmeans)
emmeans(Age8Length_lme_mod, list(pairwise ~ OA:Salinity:Temp), adjust = "tukey") #posthoc

# $`pairwise differences of OA, Salinity, Temp`
#  1                              estimate   SE df t.ratio p.value
#  High High High - Low High High  -42.819 8.36 15  -5.122  0.0024
#  High High High - High Low High   13.601 9.35 15   1.454  0.8189
#  High High High - Low Low High    -3.877 8.36 15  -0.464  0.9997
#  High High High - High High Low   -2.391 8.36 15  -0.286  1.0000
#  High High High - Low High Low    -4.329 8.36 15  -0.518  0.9993
#  High High High - High Low Low    11.457 8.44 15   1.357  0.8625
#  High High High - Low Low Low     -1.087 8.38 15  -0.130  1.0000
#  Low High High - High Low High    56.420 9.35 15   6.033  0.0005
#  Low High High - Low Low High     38.942 8.36 15   4.657  0.0057
#  Low High High - High High Low    40.428 8.36 15   4.836  0.0041
#  Low High High - Low High Low     38.490 8.36 15   4.604  0.0063
#  Low High High - High Low Low     54.277 8.44 15   6.430  0.0002
#  Low High High - Low Low Low      41.732 8.38 15   4.977  0.0031
#  High Low High - Low Low High    -17.478 9.36 15  -1.868  0.5891
#  High Low High - High High Low   -15.992 9.35 15  -1.710  0.6819
#  High Low High - Low High Low    -17.931 9.35 15  -1.917  0.5604
#  High Low High - High Low Low     -2.144 9.43 15  -0.227  1.0000
#  High Low High - Low Low Low     -14.688 9.37 15  -1.567  0.7617
#  Low Low High - High High Low      1.486 8.36 15   0.178  1.0000
#  Low Low High - Low High Low      -0.453 8.36 15  -0.054  1.0000
#  Low Low High - High Low Low      15.334 8.44 15   1.816  0.6199
#  Low Low High - Low Low Low        2.790 8.39 15   0.333  1.0000
#  High High Low - Low High Low     -1.938 8.36 15  -0.232  1.0000
#  High High Low - High Low Low     13.848 8.44 15   1.641  0.7213
#  High High Low - Low Low Low       1.304 8.38 15   0.156  1.0000
#  Low High Low - High Low Low      15.787 8.44 15   1.870  0.5879
#  Low High Low - Low Low Low        3.242 8.38 15   0.387  0.9999
#  High Low Low - Low Low Low      -12.544 8.46 15  -1.482  0.8054


# plot the data  ----------------------------------------------------------------------------------------------------- #


require(forcats)
Age8_ShellLength_Boxplot <- ggplot(data=Age8_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_bw() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 8 days", x ="pCO2 level", y = "Shell Length (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_8days_Boxplots.pdf", width=8, height=6)
print(Age8_ShellLength_Boxplot)
dev.off()







```

# Start with Endpoint Analysis

### Load Data
```{r}
#to look at headers
head(Av_length.survival_dat)
View(Av_length.survival_dat)
#Sturcture of the data - to check that variables are properly assigned to facotr or variable
str(Av_length.survival_dat)

# We need to make Aragonite a character rather than numberic so that it will plot nicely on the x-axis
Av_length.survival_dat[,12] <-as.character(Av_length.survival_dat[,12])
str(Av_length.survival_dat)
```


#Box Plot
Color codes for ggPlot2:  http://sape.inf.usi.ch/quick-reference/ggplot2/colour
This chunk has code for changing the axis titles as well as the size of the axis titles and labels so that you can make them larger and easier to read on the small screen during your presentation. 


```{r, echo=FALSE}
age_1<- Av_length.survival_dat%>%
  filter(Day=="1")

##Here Low Salinity treatments are in Blue
Age1_ShellLength_Boxplot <- ggplot(data=age_1, aes(x=AR, y=Average.Length, fill=Treatment)) +
                              geom_boxplot()+scale_fill_manual(values=c("darkorange3", "darkorange3","royalblue3", "royalblue3","orange2", "orange2","skyblue2", "skyblue2"))+
                              geom_jitter( width = 0.02) +
                              theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age =24 hours", x ="Aragonite Saturation State", y = "Shell Length (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12))


setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_24hrs.pdf", width=8, height=6)
print(Age1_ShellLength_Boxplot)
dev.off()
  
  
```

```{r, echo=FALSE}
age_1<- Av_length.survival_dat%>%
  filter(Day=="1", Temp == "High")

##Here Low Salinity treatments are in Blue
Age1_ShellLength_Boxplot_hightemp <- ggplot(data=age_1, aes(x=AR, y=Average.Length, fill=Treatment)) +
                                      geom_boxplot()+scale_fill_manual(values=c("darkorange3", "orange2","royalblue3", "lightblue3"))+
                                      geom_jitter( width = 0.02) +
                                      theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                      labs(title="Age =24 hours", x ="Aragonite Saturation State", y = "Shell Length (μm)")+ 
                                      theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                      theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_24hrs_hightemp.pdf", width=8, height=6)
print(Age1_ShellLength_Boxplot_hightemp)
dev.off()
```


```{r, echo=FALSE}
age_8<- Av_length.survival_dat%>%
  filter(Day=="8")

##Here Low Salinity treatments are in Blue
Age8_ShellLength_Boxplot <- ggplot(data=age_8, aes(x=AR, y=Average.Length, fill=Treatment)) +
                            geom_boxplot()+scale_fill_manual(values=c("darkorange3", "darkorange3","royalblue3", "royalblue3","orange2", "orange2","skyblue2", "skyblue2"))+
                                geom_jitter( width = 0.02) +
                                theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                labs(title="Age = 8 days", x ="Aragonite Saturation State", y = "Shell Length (μm)")+ 
                                theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_8days.pdf", width=8, height=6)
print(Age8_ShellLength_Boxplot)
dev.off()
```



```{r, echo=FALSE}
age_8<- Av_length.survival_dat%>%
  filter(Day=="8", Temp == "High")

##Here Low Salinity treatments are in Blue
Age8_ShellLength_Boxplot_hightemp <- ggplot(data=age_8, aes(x=AR, y=Average.Length, fill=Treatment)) +
                                geom_boxplot()+scale_fill_manual(values=c("darkorange3", "orange2","royalblue3", "lightblue3"))+
                                geom_jitter( width = 0.02) +
                                theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                labs(title="Age = 8 days", x ="Aragonite Saturation State", y = "Shell Length (μm)")+ 
                                theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Length_age_8days_hightemp.pdf", width=8, height=6)
print(Age8_ShellLength_Boxplot_hightemp)
dev.off()
```




### Linear regression of average length by Aragonite saturation 
We want to look at the adjusted R squared associated F statistics at the bottom of the results
```{r}
#Linear Regression
lmLength <- lm(age_1$Average.Length ~ age_1$AR)
summary(lmLength)

lmLength <- lm(age_8$Average.Length ~ age_8$AR)
summary(lmLength)
```
```{r}
library(nlme)

age_1<- Av_length.survival_dat%>%
  filter(Day=="1")

fit <-lme(Average.Length ~  Salinity*Temp*OA, random =~1|Replicate, data =age_1)
anova(fit)

age_8<- Av_length.survival_dat%>%
  filter(Day=="8")

fit <-lme(Average.Length ~  Salinity*Temp*OA, random =~1|Replicate, data =age_8)
anova(fit)
```







# Survival











```{r, echo=FALSE}
age_1<- Av_length.survival_dat %>%
          filter(Day=="1")





# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_1)
knitr::kable(anova(Age1_Survival_lme_mod))

# numDF	denDF	F-value	p-value
# (Intercept)	1	16	1834.683980	0.0000000
# OA	1	16	10.275543	0.0055130
# Salinity	1	16	1.647040	0.2176396
# Temp	1	16	22.720469	0.0002102
# OA:Salinity	1	16	7.527934	0.0144193
# OA:Temp	1	16	2.486540	0.1343880
# Salinity:Temp	1	16	2.070019	0.1694945
# OA:Salinity:Temp	1	16	3.096188	0.0975790


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # 0.8279- did not pass
boxplot(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lme_mod)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #


require(emmeans)
emmeans(Age1_Survival_lme_mod, list(pairwise ~ OA:Salinity:Temp), adjust = "tukey") #posthoc

# $`pairwise differences of OA, Salinity, Temp`
#  1                               estimate     SE df t.ratio p.value
#  High High High - Low High High -0.081481 0.0429 16  -1.899  0.5698
#  High High High - High Low High  0.017778 0.0429 16   0.414  0.9999
#  High High High - Low Low High  -0.105926 0.0429 16  -2.469  0.2749
#  High High High - High High Low -0.000185 0.0429 16  -0.004  1.0000
#  High High High - Low High Low   0.061481 0.0429 16   1.433  0.8296
#  High High High - High Low Low   0.154815 0.0429 16   3.608  0.0380 *
#  High High High - Low Low Low    0.023272 0.0429 16   0.542  0.9991
#  Low High High - High Low High   0.099259 0.0429 16   2.314  0.3437
#  Low High High - Low Low High   -0.024444 0.0429 16  -0.570  0.9988
#  Low High High - High High Low   0.081296 0.0429 16   1.895  0.5724
#  Low High High - Low High Low    0.142963 0.0429 16   3.332  0.0637
#  Low High High - High Low Low    0.236296 0.0429 16   5.508  0.0010 *
#  Low High High - Low Low Low     0.104753 0.0429 16   2.442  0.2862
#  High Low High - Low Low High   -0.123704 0.0429 16  -2.883  0.1415
#  High Low High - High High Low  -0.017963 0.0429 16  -0.419  0.9998
#  High Low High - Low High Low    0.043704 0.0429 16   1.019  0.9645
#  High Low High - High Low Low    0.137037 0.0429 16   3.194  0.0819
#  High Low High - Low Low Low     0.005494 0.0429 16   0.128  1.0000
#  Low Low High - High High Low    0.105741 0.0429 16   2.465  0.2766
#  Low Low High - Low High Low     0.167407 0.0429 16   3.902  0.0216 *
#  Low Low High - High Low Low     0.260741 0.0429 16   6.077  0.0003 *
#  Low Low High - Low Low Low      0.129198 0.0429 16   3.011  0.1134
#  High High Low - Low High Low    0.061667 0.0429 16   1.437  0.8276
#  High High Low - High Low Low    0.155000 0.0429 16   3.613  0.0376 *
#  High High Low - Low Low Low     0.023457 0.0429 16   0.547  0.9991
#  Low High Low - High Low Low     0.093333 0.0429 16   2.175  0.4132
#  Low High Low - Low Low Low     -0.038210 0.0429 16  -0.891  0.9828
#  High Low Low - Low Low Low     -0.131543 0.0429 16  -3.066  0.1030


# plot the data  ----------------------------------------------------------------------------------------------------- #




Age1_Survival_Boxplot_2 <- age_1 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_24hrs_MeanSE.pdf", width=8, height=6)
print(Age1_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age1_Survival_Boxplot <- ggplot(data=age_1, aes(x=AR, y=Survival, fill=Treatment)) +
                            geom_boxplot()+scale_fill_manual(values=c("darkorange3", "darkorange3","royalblue3", "royalblue3","orange2", "orange2","skyblue2", "skyblue2"))+
                            geom_jitter( width = 0.02) +
                            theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                            theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                            labs(title="Age =24 hours", x ="Aragonite Saturation State", y = "Survival (%)")+ 
                            theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                            theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_24hrs.pdf", width=8, height=6)
print(Age1_Survival_Boxplot)
dev.off()
```

```{r, echo=FALSE}
age_8<- Av_length.survival_dat%>%
  filter(Day=="8")


# Age 8 Length mod - all data -------------------------------------------------------------------------------------- #


Age8_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_8)
knitr::kable(anova(Age8_Survival_lme_mod))

# 	numDF	denDF	F-value	p-value
# (Intercept)	1	14	35.8522871	0.0000332
# OA	1	14	0.6474869	0.4344654
# Salinity	1	14	11.3729912	0.0045564
# Temp	1	14	0.3131010	0.5846252
# OA:Salinity	1	14	0.0000578	0.9940392
# OA:Temp	1	14	0.5313363	0.4780633
# Salinity:Temp	1	14	0.0013027	0.9717174
# OA:Salinity:Temp	1	14	0.1058076	0.7497789


# Levene's test and visuals of the residuals ----------------------------------------------------------------------- #


leveneTest(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # 0.5706 pass
boxplot(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # visual of residuals grouped
qqnorm(resid(Age8_Survival_lme_mod)) # check for normality of residuals - looks okay



# post hoc tests --------------------------------------------------------------------------------------------------- #


require(emmeans)
emmeans(Age8_Survival_lme_mod, list(pairwise ~ Salinity), adjust = "tukey") #posthoc

# $`emmeans of Salinity`
#  Salinity emmean     SE df lower.CL upper.CL
#  High     0.3775 0.0561 14    0.257    0.498
#  Low      0.0887 0.0684 14   -0.058    0.235


# plot the data  ----------------------------------------------------------------------------------------------------- #
Age8_Survival_Boxplot_2 <- age_8 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_24hrs_MeanSE.pdf", width=8, height=6)
print(Age8_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age8_Survival_Boxplot <- ggplot(data=age_8, aes(x=AR, y=Survival, fill=Treatment)) +
                                  geom_boxplot()+scale_fill_manual(values=c("darkorange3", "darkorange3","royalblue3", "royalblue3","orange2", "orange2","skyblue2", "skyblue2"))+
                                  geom_jitter( width = 0.02) +
                                  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                  labs(title="Age = 8 days", x ="Aragonite Saturation State", y = "Survival (%)")+ 
                                  theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                  theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_8days.pdf", width=8, height=6)
print(Age8_Survival_Boxplot)
dev.off()

```

```{r, echo=FALSE}
age_8<- Av_length.survival_dat%>%
  filter(Day=="8", Temp == "High")

##Here Low Salinity treatments are in Blue
Age8_Survival_Boxplot_hightemp <- ggplot(data=age_8, aes(x=AR, y=Survival, fill=Treatment)) +
                                  geom_boxplot()+scale_fill_manual(values=c("darkorange3", "orange2","royalblue3", "skyblue2"))+
                                  geom_jitter( width = 0.02) +
                                  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                  labs(title="Age = 8 days", x ="Aragonite Saturation State", y = "Survival (%)")+ 
                                  theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                                  theme(axis.text=element_text(size=12))
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length_Survival/Survival_age_8days_hightemp.pdf", width=8, height=6)
print(Age8_Survival_Boxplot_hightemp)
dev.off()
```

### Linear regression of average length by Aragonite saturation 
We want to look at the adjusted R squared associated F statistics at the bottom of the results
```{r}
#Linear Regression
lmSurvival <- lm(age_1$Survival ~ age_1$AR)
summary(lmSurvival)

lmSurvival <- lm(age_8$Survival ~ age_8$AR)
summary(lmSurvival)
```

```{r}
library(nlme)

age_1<- Av_length.survival_dat%>%
  filter(Day=="1")

fit <-lme(Survival.Tans ~  Salinity*Temp*OA, random =~1|Replicate, data =age_1)
anova(fit)

age_8<- Av_length.survival_dat%>%
  filter(Day=="8")

fit <-lme(Survival.Tans ~  Salinity*Temp*OA, random =~1|Replicate, data =age_8)
anova(fit)

fit2 <-lme(Survival.Tans ~  Treatment, random =~1|Replicate, data =age_8)
anova(fit2)
#tukey_hsd(fit2)
```


### Linear regression of average length by Aragonite saturation 
We want to look at the adjusted R squared associated F statistics at the bottom of the results
```{r}
#Linear Regression
lmSurvival <- lm(age_1$Survival ~ age_1$AR)
summary(lmSurvival)

lmSurvival <- lm(age_8$Survival ~ age_8$AR)
summary(lmSurvival)
```


#print session info so that you know what versions were used for this analysis
```{r}
sessionInfo()
```

