---
title: "Cvirginica experiment: Seawater Chemistry"
author: "Samuel Gurr"
date: "9/22/2021"
output: html_document
---

```{r setup, include=FALSE}
# Purpose: Oyster project 2021 - Respiration rate data 
# analysis of respiration rate data
# Written by: Sam J Gurr (last edit 9/14/2021)

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::
library(dplyr)
library(ggplot2)
library(reshape2)
library(qwraps2)
library(knitr)
library(kableExtra)
library(car)
library(agricolae) # tukey letters
# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis") # personal computer
# setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Cvriginica_multistressor/RAnalysis") # Work computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# chem <- read.csv(file="Data/Water_chem/Chem_logsheet_raw.csv", header=TRUE) # load the chem data
chem <- read.csv(file="Data/Water_chem/cumulative_raw/Seawater_chem_raw.csv", header=TRUE) # load the chem data
names(chem)<-gsub("\\..","_",names(chem)) # insert underscore sin the column names to ease reading the columns 
# View(chem) # view the file
```


# PLOTS AND ANALYSIS - Aragonite saturation levels

```{r}
# Objective: Aragonite saturation state ties together the high vs. low full reciprocal Temp x OA x salinity challenge 
# in which two major factors (1) low salinity and (2) high pCO2 drive differences in aragoinite saturation state 
# interestingly it appears there are 4 groups 
# (1) low aragoinite as low sal+high pCO2
# (2)  high aragonite as high salinity low pCO2
# (3a) mid aragonite driven by low slainity (and low pCO2)
# (3b) mid aragonite driven by high pCO2 (under high salinity)

# in this chunk... 
# I will plot and statistically examine differences in aragonite saturation state for all 8 groups and in the consolidated 4 described above 


#  CONSOLIDATE TARGET DATA, NAME NEW COLUMNS 
names(chem)
chem.aragonite <- chem %>% 
  tidyr::drop_na(WAr_out) %>% # omit rows with NA for aragonite sat state
  dplyr::select(c('Date','Chamber_.','Temp','pCO2','Sal','WAr_out')) %>% 
  dplyr::mutate(all_treat = paste(Temp,pCO2, Sal, sep = '_')) %>% 
  dplyr::mutate(OAxSal = paste(pCO2, Sal, sep = '_')) 



# ALL TREATMENTS as temp X OA X Salinity

alltreat.Date.MEANS <- chem.aragonite %>% 
  dplyr::group_by(Date, all_treat) %>% 
  dplyr::summarise(mean_AragoniteSat.date  = mean(WAr_out), 
                    n                 = n(),
                    sd_AragoniteSat.date   = sd(WAr_out),
                    se_AragoniteSat.date   = sd_AragoniteSat.date/(sqrt(n))) 

all.mod <- aov(log(mean_AragoniteSat.date) ~  all_treat, data= alltreat.Date.MEANS) # outlier [-35,]
shapiro.test(resid(all.mod)) # 0.04996  normal
leveneTest(all.mod) # 0.4938 pass
qqnorm(resid(all.mod)) # view qqnrom
hist(resid(all.mod)) # view histogram
summary(all.mod) # summary printed below...
#             Df Sum Sq Mean Sq F value Pr(>F)    
# all_treat    7 20.365  2.9093    1017 <2e-16 ***
# Residuals   40  0.114  0.0029 

# posthoc
allmod.means   <- emmeans::emmeans(object = all.mod, pairwise ~ "all_treat", adjust = "tukey")
allmod.letters <- HSD.test(all.mod, "all_treat", group=TRUE)
#      log(mean_AragoniteSat.date) groups
# H_L_H                   0.5599737      a
# L_L_H                   0.4108005      b
# H_H_H                  -0.2443737      c
# H_L_L                  -0.4024329      d interesting
# L_H_H                  -0.4141954      d interesting - the mid treatments driven by differing factors
# L_L_L                  -0.6065619      e
# H_H_L                  -1.2120345      f
# L_H_L                  -1.4448603      g
library(forcats)
AragonitePlot <- alltreat.Date.MEANS %>% 
      dplyr::mutate(Temp = substr(all_treat, 1,1)) %>%
      dplyr::mutate(pCO2 = substr(all_treat, 3,3)) %>%
      dplyr::mutate(Sal = substr(all_treat, 5,5)) %>%
      dplyr::mutate(pCO2xSal = paste(pCO2, Sal, sep = '_')) %>% 
      dplyr::mutate(pCO2xSal = fct_reorder(pCO2xSal, mean_AragoniteSat.date)) %>%  # reorder for x axis
      dplyr::mutate(Temp = fct_relevel(Temp, "L", "H")) %>% 
        ggplot(aes(pCO2xSal , mean_AragoniteSat.date, grfill = Temp)) +
        theme(panel.grid=element_blank()) +
        geom_boxplot(size=0.2, alpha=0.1) +
        scale_fill_manual(values=c("grey50", "white")) +
        geom_point(aes(fill=Temp), 
                   shape = 21, 
                   size = 2, 
                   position = position_jitterdodge(jitter.width = 0.1)) +
        theme_classic() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=12)) +
        stat_summary(fun.y=mean, 
                     geom="point", 
                     shape=18, 
                     size=4, 
                     color="black", 
                     fill="white")

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Water_Chem/")
pdf("plots/AragoniteSaturation_meansbydate.pdf", width=8, height=8)
print(AragonitePlot)
dev.off()


alltreat.MEANS      <- alltreat.Date.MEANS %>% 
  dplyr::group_by(all_treat) %>% 
  dplyr::summarise(mean_AragoniteSat.all  = mean(mean_AragoniteSat.date), 
                    n                     = n(),
                    sd_AragoniteSat.all   = sd(mean_AragoniteSat.date),
                    se_AragoniteSat.all   = sd_AragoniteSat.all/(sqrt(n))) 

alltreat.MEANS


# OA x SALINITY  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
OAxSal.Date.MEANS <- as.data.frame(chem.aragonite %>% 
  dplyr::select(!'Chamber_.') %>% 
  #dplyr::filter(!Date %in% '5/21/2021') %>% 
  dplyr::group_by(Date, OAxSal) %>% 
  dplyr::mutate(mean_AragoniteSat.date  = mean(WAr_out)) %>% 
  dplyr::mutate(sd_AragoniteSat.date   = sd(WAr_out)) %>% 
  dplyr::mutate(n   = n()) %>%   
  dplyr::mutate(se_AragoniteSat.date   = sd_AragoniteSat.date/(sqrt(n))))

# anova 
OAxSal.mod <- aov(log(mean_AragoniteSat.date) ~  OAxSal, data= OAxSal.Date.MEANS) # outlier [-35,]
summary(OAxSal.mod)
shapiro.test(resid(OAxSal.mod)) # 0.05979 non normal
leveneTest(OAxSal.mod) # 0.005407 **
qqnorm(resid(OAxSal.mod))
hist(resid(OAxSal.mod))
TukeyHSD(OAxSal.mod)
OAxSalmod.means   <- emmeans::emmeans(object = OAxSal.mod, pairwise ~ "OAxSal", adjust = "tukey")
OAxSalmod.letters <- HSD.test(OAxSal.mod, "OAxSal", group=TRUE) #library(agricolae)
#     log(mean_AragoniteSat.date) groups
# L_H                   0.4888538      a
# H_H                  -0.3253907      b
# L_L                  -0.4990795      c
# H_L                  -1.3103774      d



```

# TABLE 

```{r use dplyr to build chemistry table, include=FALSE}
names(chem)
chem_sub <- chem %>% 
  # dplyr::filter(Date %in% c('4/29/2021', '5/3/2021', '5/7/2021', '5/10/2021', '5/14/2021', '5/17/2021', '5/21/2021')) %>% 
  # dplyr::select(c('Date', 'Chamber_', 'Temp','OA_CO2', 'Salinity', 't_C_treatment', 'Salinity_','TA_mmol_gSW.', 'pH_ut', 'pCO2_ut_matm.', 'WCa_ut', 'WAr_ut')) %>% 
  # dplyr::mutate(Temp_OA_Sal = paste(Temp, OA_CO2, Salinity, sep = "_")) %>% 
    dplyr::filter(Date %in% c('4/29/2021', '5/3/2021', '5/7/2021', '5/10/2021', '5/14/2021', '5/17/2021', '5/21/2021')) %>% 
  dplyr::select(c('Date', 'Chamber_.', 'Temp','pCO2', 'Sal', 't_oC_out', 'Salinity','pH_out_chamber','pCO2_out_matm', 'TA__mmol_gSW__Corrected_with_the_CRM', 'WCa_out', 'WAr_out')) %>% 
  dplyr::mutate(Temp_OA_Sal = paste(Temp, pCO2, Sal, sep = "_")) %>% 
# dplyr::group_by(Date, Temp_OA_Sal) %>%  
  dplyr::group_by(Temp_OA_Sal) %>%  
  na.omit() %>% 
  dplyr::summarise(
    meanTemperature     = mean((as.numeric(t_oC_out))),
    sdTemperature       = sd(t_oC_out),

    meanSalinity        = mean(Salinity),
    sdSalinity          = sd(Salinity),

    meanpH              = mean(pH_out_chamber),
    sdpH                = sd(pH_out_chamber),

    meanpCO2            = mean(pCO2_out_matm),
    sdpCO2              = sd(pCO2_out_matm),

    meanTotalAlkalinity = mean(TA__mmol_gSW__Corrected_with_the_CRM),
    sdTotalAlkalinity   = sd(TA__mmol_gSW__Corrected_with_the_CRM),

    meanCalcite         = mean(WCa_out),
    sdCalcite           = sd(WCa_out),

    meanAragonite       = mean(WAr_out),
    sdAragonite         = sd(WAr_out),

    n = n())

# add treatments
chem_sub$Temperature <- c('High','High','High','High','Low','Low','Low','Low')
chem_sub$pCO2 <- c('High','High','Low','Low','High','High','Low','Low')
chem_sub$Salinity <- c('High','Low','High','Low','High','Low','High','Low')

# final table
FINAL_TABLE                <- data.frame(matrix(nrow = nrow(chem_sub), ncol = 1))
FINAL_TABLE$temp           <- chem_sub$Temperature
FINAL_TABLE$OA             <- chem_sub$pCO2
FINAL_TABLE$sal            <- chem_sub$Salinity
FINAL_TABLE$N              <- chem_sub$n
FINAL_TABLE$Temperature    <- paste( (signif(chem_sub$meanTemperature, digits=3)), (signif(chem_sub$sdTemperature, digits=3)), sep=" ± ")
FINAL_TABLE$pCO2           <- paste( (signif(chem_sub$meanpCO2, digits=3)), (signif(chem_sub$sdpCO2, digits=3)), sep=" ± ")
FINAL_TABLE$Salinity       <- paste( (signif(chem_sub$meanSalinity, digits=3)), (signif(chem_sub$sdSalinity, digits=3)), sep=" ± ")
FINAL_TABLE$pH             <- paste( (signif(chem_sub$meanpH, digits=3)), (signif(chem_sub$sdpH, digits=3)), sep=" ± ")
FINAL_TABLE$TA             <- paste( (signif(chem_sub$meanTotalAlkalinity, digits=3)), (signif(chem_sub$sdTotalAlkalinity, digits=3)), sep=" ± ")
FINAL_TABLE$Aragonite.Sat  <- paste( (signif(chem_sub$meanAragonite, digits=3)), (signif(chem_sub$sdTotalAlkalinity, digits=3)), sep=" ± ")
FINAL_TABLE$Calcite.Sat    <- paste( (signif(chem_sub$meanCalcite, digits=3)), (signif(chem_sub$sdCalcite, digits=3)), sep=" ± ")
FINAL_TABLE                <- FINAL_TABLE[,-1] # view table
```


## knitR to print the table 
```{r lable output, echo=TRUE}
FINAL_TABLE %>%
  kbl(caption = "Table 1. Seawater chemistry") %>%
  kable_classic(full_width = T, html_font = "Cambria")
```


#### save data
```{r save tables, echo=TRUE}
# save output table
write.table(chem_sub,"C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Water_Chem/Chem.Table_sep.csv",sep=",", row.names=FALSE)  # write table to 
write.table(FINAL_TABLE,"C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Water_Chem/Chem.Table.csv",sep=",", row.names=FALSE)  # write table to 

```