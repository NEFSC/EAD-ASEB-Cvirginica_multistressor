---
title: "Survival_analysis.Rmd"
author: "Sam Gurr"
date: "11/2/2022"
output:
  pdf_document: default
  html_document: default
---


# load libraries

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(Rmisc)
library(tidyverse)
library(dplyr)
library(lme4)
library(ggplot2)
library(nlme)
library(car)
library(performance)
library(emmeans)
library(pander)
library(survival)
library(vegan)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(dplyr)
library(rcompanion)
library(FSA)
library(car)
library(forcats)
library(kableExtra) # nice Rmd tables
library(emmeans)
library(ggpubr)
library(survival)
library(Rmisc)
library(coxme)
library(survminer)
library(ggsurvfit) # survfit2
library(gtsummary) # tbl_survfit
# SET WORKING DIRECTORY 
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/")
knitr::opts_knit$set(root.dir = "C:/Users/samuel.gurr/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/")

```


# load data

```{r load data}

# survival data
Survival_data <- read.csv("Data/Survival/Survival_master.csv", header = T) %>% 
                            dplyr::mutate(random_fact = paste( substr(Temp,1,1), 
                                                               substr(OA,1,1), 
                                                               substr(Salinity,1,1), '_', Replicate, sep = ''))
# View(Survival_dat)
# head(Survival_dat) # view first few lines


Survival_summ <- summarySE(Survival_data, 
                              measurevar="Survival", 
                              groupvars=c("Day", "Temp", "OA", "Salinity", "AR")) %>%
                        dplyr::arrange(AR) %>% 
                        dplyr::arrange(Day) %>% 
                        dplyr::mutate(mean_SE = paste0(
                          signif(Survival, digits=3),
                          " Â± ",
                          signif(se, digits=3)))

write.csv(Survival_summ, "Output/Survival/Survival_Perc_MeanSE.csv")
```


# Prep data 

```{r, prep the raw data for stats} 
# extract the experiment data with corresponding sample Ids from the averaged data master file...
Exp_data <-  Survival_data %>% 
                filter(Day %in% 1) %>% 
                dplyr::select(c('Temp','OA','Salinity','Replicate','Id.', 'pH', 'AR')) %>% 
                dplyr::rename(Sample.ID = Id., Aragonite_saturation = AR)

```
 
 
 
# Plot all data
```{r survival to hatch and day 15 - for MAS presentation} 
 
######################################################## #
# Survival day 1
Survival_means_day1 <- Survival_data %>% 
                                dplyr::filter(Day == 1) %>% 
                                na.omit() %>% 
                                dplyr::group_by(Day, OA, Salinity, Temp) %>% 
                                dplyr::summarise(mean_survival = mean(Survival), 
                                                 n           = n(),
                                                 sd_survival   = sd(Survival),
                                                 se_survival   = sd_survival/(sqrt(n))) %>%  
                                dplyr::mutate(Survival_to_hatch = (mean_survival) *100 ) %>% 
                                dplyr::mutate(OA_Sal = paste(substr(OA,1,1),
                                              substr(Salinity,1,1),
                                                  sep = ''))

Heatplot_Day1 <- Survival_means_day1 %>% 
       dplyr::mutate(Day = as.factor(Day)) %>% 
       ggplot(aes(x = Day,
                  y = mean_survival)) + 
      geom_point(color = 'black') +
      geom_line(aes(x = Day,
                    y = mean_survival)) +
      geom_errorbar(aes(ymin = mean_survival - se_survival, 
                        ymax = mean_survival + se_survival), 
                        width = 0.5, 
                        position= "dodge2") +
      geom_smooth(method = "lm", 
                  se = FALSE, 
                  size = 1, 
                  color = 'white') +
      theme_bw() +  
      theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank()) +
      facet_grid(vars(Temp), 
                 vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH")))) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/plots/Survival_hatch_facetted.pdf", width=11, height=5)
print(Heatplot_Day1)
dev.off()



```
 
```{r survival to set - days 4 to 15} 

# plot - Survival  after day 1

Survival_means <- Survival_data %>% 
                          dplyr::filter(Day >1) %>% 
                          #na.omit() %>% 
                          dplyr::group_by(Day, OA, Salinity, Temp) %>% 
                          dplyr::summarise(mean_survival = mean(Survival), 
                                           n           = n(),
                                           sd_survival   = sd(Survival),
                                           se_survival   = sd_survival/(sqrt(n)))



Survival_to_set_means <- as.data.frame(Survival_means %>% 
  filter(Day %in% 15) %>% 
  dplyr::select(c(Day, OA, Salinity, Temp, mean_survival)) %>% 
  dplyr::group_by(OA, Salinity, Temp)  %>% 
  tidyr::spread(Day, mean_survival) %>%  # new columns titled 1 and 15 for he Age and with values for the 
  # length data grouped by treatment 
  dplyr::mutate(Survival_to_set = (`15`) *100 ) %>% 
  dplyr::select(!`15`)) 

Survival_means_MASTER <- merge(Survival_means, Survival_to_set_means, by=c('OA', 'Salinity', 'Temp')) %>% 
                              dplyr::mutate(OA_Sal = paste(substr(OA,1,1),
                                              substr(Salinity,1,1),
                                                  sep = ''))

# plot - survival

Heatplot <- Survival_means_MASTER %>% 
       ggplot(aes(x = Day,
                  y = mean_survival)) + 
       geom_rect(aes(fill = Survival_to_set), 
                   xmin = -Inf, 
                   xmax = Inf, 
                   ymin = -Inf, 
                   ymax = Inf, 
                   alpha = 0.3) +
      geom_point(color = 'black') +
      geom_line(aes(x = Day,
                    y = mean_survival)) +
      geom_errorbar(aes(ymin = mean_survival - se_survival, 
                        ymax = mean_survival + se_survival), 
                        width = 0.5, 
                        position= "dodge2") +
      geom_smooth(method = "lm", 
                  se = FALSE, 
                  size = 1, 
                  color = 'white') +
      theme_bw() +  
      theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank()) +
      facet_grid(vars(Temp), 
                 vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH")))) +
      geom_text(size = 2, 
                   aes(x = 12, 
                       y = 0.8, 
                       label = paste0(round(Survival_to_set,2),"% survival to set"))) +
      scale_fill_gradient(low = "orange", 
                           high = "forestgreen", 
                           aesthetics = "fill")
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/plots/Survival_all_facetted.pdf", width=11, height=5)
print(Heatplot)
dev.off()


Survival_all_MeanSE_plot <- Survival_means %>% 
                                dplyr::mutate(AllTreat = as.factor(paste(OA, Salinity, Temp, sep = '_'))) %>% 
                                ggplot(aes(x = as.numeric(Day),
                                           y = mean_survival, 
                                           group = AllTreat,
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_point(aes(colour = fct_relevel(Salinity, c("Low", "High")), 
                                           shape = fct_relevel(OA, c("Low", "High"))),
                                           width = 0.5,
                                           position = "dodge2") +
                                geom_line(aes(x = as.numeric(Day),
                                           y=mean_survival, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_errorbar(aes(ymin = mean_survival - se_survival, 
                                                  ymax = mean_survival + se_survival), 
                                              width = 0.5, position= "dodge2") +
                                theme_minimal() +  
                                stat_summary(geom="ribbon", fun.data=mean_cl_normal, width=0.1, conf.int=0.95, fill="lightblue")+
                                facet_wrap(~(fct_relevel(OA, c("Low", "High"))))
Survival_all_MeanSE_plot # view the plot
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_all_MeanSE.pdf", width=11, height=6)
print(Survival_all_MeanSE_plot)
dev.off()





Heatplot_day15 <- Survival_means_MASTER %>% 
  dplyr::filter(Day %in% 15) %>% 
  dplyr::mutate(Day = as.factor(Day)) %>% 
       ggplot(aes(x = Day,
                  y = mean_survival)) + 
      geom_point(color = 'black') +
      geom_line(aes(x = Day,
                    y = mean_survival)) +
      geom_errorbar(aes(ymin = mean_survival - se_survival, 
                        ymax = mean_survival + se_survival), 
                        width = 0.5, 
                        position= "dodge2") +
      geom_smooth(method = "lm", 
                  se = FALSE, 
                  size = 1, 
                  color = 'white') +
      theme_bw() +  
      theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank()) +
      facet_grid(vars(Temp), 
                 vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH")))) 
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/plots/Survival_Day15.pdf", width=11, height=5)
print(Heatplot_day15)
dev.off()




```


# Survival STATS Kaplan Meier and Cox regression models (hazard analysis)


* covert counts to binary format, use 'Survival' column which is a % as a fraction integer to get 'Count_dead'

* note that we did a survival assesment to D-hinge over just a single day, animals were 
stocked near equally to rerun from 4 - 15, here we should do a survival analysis 

```{r format darafile in prep for binary loop}
# create new columns for live and dead based on the count and proportion (of alive) tobackcalculate dead - these are integers! 
df_survival <- Survival_data %>% 
          dplyr::mutate(Counts = 
                          as.numeric(gsub(",","",Counts))) %>%# remove the commas from these numbers- id as character if not removed!
          dplyr::rename(Count_alive = Counts,
                        Tank = Id.) %>% # rename to avoid confusion
          dplyr::mutate(Count_total = case_when(Survival == 0 ~ 0,
                                               Survival >0 ~
                                                 (1/as.numeric(Survival))*
                                                 as.numeric(Count_alive)),# proportion is that of alive
                        Count_dead = Count_total - Count_alive)

df_survival_4_15 <- df_survival %>% dplyr::filter(!Day %in% c(1, 18))
```

```{r convert to binary days 4- 15}

# (1) Including tank - to use as surv object in coxme statistics (random factor included!) not suitable for plotting

# Call the cumulative dataframe that we will write to in the for loop below
survival_4_15     <- data.frame() # start dataframe  - all
# run it 
for (i in 1:nrow(df_survival_4_15)) {
   #count_alive <- round(df_survival_4_15[1,]$Count_alive/100) # divide all counts by 1000, round to nearest
   #count_dead  <- round(df_survival_4_15[1,]$Count_dead/100)  # divide all counts by 1000, round to nearest
   
   count_alive <- round(df_survival_4_15[i,]$Count_alive) # raw counts
   count_dead  <- round(df_survival_4_15[i,]$Count_dead)  # raw counts
   
   loopDF           <- data.frame(matrix(0,ncol = 6, nrow = (count_alive + count_dead))) 
   colnames(loopDF) <- (c('Temp','OA', 'Salinity','Tank','Day','Count_dead'))
   loopDF           <- loopDF %>% 
                            dplyr::mutate(
                            Temp      = df_survival_4_15[i,]$Temp,
                            OA        = df_survival_4_15[i,]$OA,
                            Salinity  = df_survival_4_15[i,]$Salinity,
                            Tank      = df_survival_4_15[i,]$Tank,  
                            Day       = df_survival_4_15[i,]$Day,
                          ) 
  loopDF[c(1:count_dead),6] = 1 # 1 for dead 
  loopDF[c((count_dead + 1):nrow(loopDF)),6] = 0 # 0 for alive

  loopDF           <- data.frame(loopDF) # name dataframe for this single row
  survival_4_15 <- rbind(survival_4_15,loopDF) #bind to a cumulative list dataframe
}


# To address tank as a random factor it MUST be numeric, change this here
unique(survival_4_15$Tank) #1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 NA
survival_4_15 <- survival_4_15 %>% 
                    filter(!Tank %in% NA) %>% # omit the NA, same name not great practice but whateva
                    dplyr::mutate(All = paste0(Salinity,OA,Temp),
                                  OA = factor(OA, levels = c("Low", "High"))) #merge treatments
survival_4_15$Tank <- as.numeric(survival_4_15$Tank)
unique(survival_4_15$All)

survival_4_15$All   <- factor(survival_4_15$All, levels = c("HighLowHigh", "HighLowLow", 
                                                            "HighHighHigh", "HighHighLow",
                                                            "LowLowHigh", "LowLowLow", 
                                                            "LowHighHigh", "LowHighLow"))



# (2) Mean counts alive and dead by tank - better representated for plots!
# difference here is we take a mean for counts alive and dead within treatment, no tank included and a singluar line for plotting 
df_survival_4_15_MEANS <- df_survival_4_15 %>% 
              dplyr::select(c(Salinity, OA,Temp, Day, Count_dead, Count_alive)) %>% 
              dplyr::group_by(Salinity, OA,Temp, Day) %>% 
              dplyr::summarise(mean_Count_alive = mean(Count_alive), 
                               mean_Count_dead = mean(Count_dead))

# call datafarme binary for plotting
survival_4_15_MEANS       <- data.frame() # start dataframe 

# run it 
for (i in 1:nrow(df_survival_4_15_MEANS)) {
   count_alive <- round(df_survival_4_15_MEANS[i,]$mean_Count_alive) # divide all counts by 1000, round to nearest
   count_dead  <- round(df_survival_4_15_MEANS[i,]$mean_Count_dead)  # divide all counts by 1000, round to nearest
   
   loopDF           <- data.frame(matrix(0,ncol = 5, nrow = (count_alive + count_dead))) 
   colnames(loopDF) <- (c('Temp','OA', 'Salinity','Day','Count_dead'))
   loopDF           <- loopDF %>% 
                            dplyr::mutate(
                            Temp      = df_survival_4_15_MEANS[i,]$Temp,
                            OA        = df_survival_4_15_MEANS[i,]$OA,
                            Salinity  = df_survival_4_15_MEANS[i,]$Salinity,
                            Day       = df_survival_4_15_MEANS[i,]$Day,
                          ) 
  loopDF[c(1:count_dead),5] = 1 # 1 for dead 
  loopDF[c((count_dead + 1):nrow(loopDF)),5] = 0 # 0 for alive

  loopDF           <- data.frame(loopDF) # name dataframe for this single row
  survival_4_15_MEANS <- rbind(survival_4_15_MEANS,loopDF) #bind to a cumulative list dataframe
  
}

survival_4_15_MEANS      <- survival_4_15_MEANS %>% 
                            dplyr::mutate(All = paste0(Salinity,OA,Temp),
                                  OA = factor(OA, levels = c("Low", "High"))) #merge treatments
survival_4_15_MEANS$All  <- factor(survival_4_15_MEANS$All, levels = c("HighLowHigh", "HighLowLow", 
                                                            "HighHighHigh", "HighHighLow",
                                                            "LowLowHigh", "LowLowLow", 
                                                            "LowHighHigh", "LowHighLow"))

```

```{r surv object}

# surv_all      <- survfit2(Surv(Day, Count_dead) ~ All, data = survival_4_15)
surv_all            <- survfit2(Surv(Day, Count_dead) ~ Salinity+OA+Temp, data = survival_4_15)

surv_all.means      <- survfit2(Surv(Day, Count_dead) ~ Salinity+OA+Temp, data = survival_4_15_MEANS)

```

```{r plot Kaplan Meier}

Surv_larvaeKaplanMeier <- surv_all %>% 
                        ggsurvfit(linetype_aes = F, linewidth = 1) +
                        scale_color_manual(values = c("darkgreen","forestgreen","lightgreen", "yellowgreen",
                                                      "darkslateblue", "darkorchid4","darkorchid2", "plum")) +
                        scale_fill_manual(values = c("darkgreen","forestgreen","lightgreen", "yellowgreen",
                                                      "darkslateblue", "darkorchid4","darkorchid2", "plum")) +
                        labs(
                          x = "Days",
                          y = "Overall survival probability"
                        ) + 
                        add_confidence_interval() +
                        # add_risktable() +
                        # add_risktable_strata_symbol() + # (symbol = "\U25CF", size = 10
                        scale_ggsurvfit(x_scales = list(breaks = 0:15)) #+
                       # add_pvalue(location  = "annotation", x = 8.5)

# plot the surv data
pdf("Output/Survival/Survival_KaplanMeier.pdf", width=5, height = 4)
Surv_larvaeKaplanMeier
dev.off()

```

# Comparing survival times between groups (log-rank test)
* We can conduct between-group significance tests using a log-rank test. The log-rank test equally weights observations over the entire follow-up time and is the most common way to compare survival times between groups. There are versions that more heavily weight the early or late follow-up that could be more appropriate depending on the research question (see ?survdiff for different test options).
* We get the log-rank p-value using the survdiff function
```{r log-rank test survdiff}

Surv_logrank_test <- survdiff(formula = Surv(Day, Count_dead) ~ Salinity+Temp+OA, data = survival_4_15)
#                                        N Observed Expected (O-E)^2/E (O-E)^2/V
# Salinity=High, Temp=High, OA=Low  185912   123579   145823      3393      7376
# Salinity=High, Temp=High, OA=High 189017   130026   150566      2802      6149
# Salinity=High, Temp=Low , OA=Low  193131   113998   149655      8496     18438
# Salinity=High, Temp=Low , OA=High 191955   134055   149946      1684      3671
# Salinity=Low, Temp=High, OA=Low   191592   162054   150922       821      1796
# Salinity=Low, Temp=High, OA=High  176791   155790   124494      7867     15932
# Salinity=Low, Temp=Low , OA=Low   193881   157731   151555       252       550
# Salinity=Low, Temp=Low , OA=High  158739   133214    87487     23901     42720
# 
#  Chisq= 86002  on 7 degrees of freedom, p= <2e-16
Surv_logrank_test <- survdiff(formula = Surv(Day, Count_dead) ~ All, data = survival_4_15) # same results
#                       N Observed Expected (O-E)^2/E (O-E)^2/V
# All=HighHighHigh 189017   130026   150566      2802      6149
# All=HighHighLow  191955   134055   149946      1684      3671
# All=HighLowHigh  185912   123579   145823      3393      7376
# All=HighLowLow   193131   113998   149655      8496     18438
# All=LowHighHigh  176791   155790   124494      7867     15932
# All=LowHighLow   158739   133214    87487     23901     42720
# All=LowLowHigh   191592   162054   150922       821      1796
# All=LowLowLow    193881   157731   151555       252       550
# 
#  Chisq= 86002  on 7 degrees of freedom, p= <2e-16
```

# The Cox regression model
* We may want to quantify an effect size for a single variable, or include **more than one variable** into a regression model to account for the effects of multiple variables.
* The Cox regression model is a semi-parametric model that can be used to fit univariable and multivariable regression models that have survival outcomes.
# Run several mdoels 

- mixed models - theseinclude all data with the Tank replicate (not the mean binary data!)
  
  * all - use 'pCO2_all' to run 
  
  * additive model - Parent_pCO2 and Larvae_pCO2 to explore main effects

### Mixed model - all
```{r cox & hazard ratio -  all mixed model}
library(survminer) # ggforect hazard ratio plot
library(finalfit)

# assing dependent and explanatory includign tnak as frailty (review finatfit), run thsi 
# alonside models using cexpH and such
dependent_os  <- "Surv(Day, Count_dead)"
explanatory   <- c("All", "frailty(Tank)")
explanatory   <- "All"


coxph_test         <- coxph(formula = Surv(Day, Count_dead) ~ # using coxpH and Tank as random factor using 'frailty'
                                   Salinity + OA + Temp, # exclude +frailty(Tank) to be able to generate hazard plot
                                 data = survival_4_15)
#                 coef exp(coef) se(coef)     z      p
# SalinityLow 0.487250  1.627833 0.001932 252.2 <2e-16
# OAHigh      0.250322  1.284439 0.001918 130.5 <2e-16
# TempLow     0.061206  1.063118 0.001907  32.1 <2e-16


coxph_test_all         <- coxph(formula = Surv(Day, Count_dead) ~ # using coxpH and Tank as random factor using 'frailty'
                                   All, # exclude +frailty(Tank) to be able to generate hazard plot
                                 data = survival_4_15)
#                      coef exp(coef)  se(coef)      z      p
# AllHighLowLow   -0.080214  0.922919  0.004108 -19.52 <2e-16
# AllHighHighHigh  0.054349  1.055853  0.003974  13.68 <2e-16
# AllHighHighLow   0.150187  1.162051  0.003953  37.99 <2e-16
# AllLowLowHigh    0.350595  1.419912  0.003784  92.66 <2e-16
# AllLowLowLow     0.345145  1.412195  0.003811  90.56 <2e-16
# AllLowHighHigh   0.579956  1.785959  0.003828 151.50 <2e-16
# AllLowHighLow    0.817281  2.264334  0.003983 205.22 <2e-16

?finalfit
survival_4_15 %>%  # same as above, using finalfit to output, includes frailty
    finalfit(dependent_os, explanatory, add_dependent_label = FALSE)

# survival_4_15 %>%  # same as above, using finalfit to output, includes frailty
#     finalfit(dependent_os, explanatory, add_dependent_label = FALSE)


# mixed Cox analysis 
survival_4_15$Tank     <- factor(survival_4_15$Tank)
survival_4_15$cluster  <- factor(survival_4_15$Tank)
survival_4_15          <- droplevels(survival_4_15)

coxph_test.mixed.int   <- coxph(Surv(Day, Count_dead) ~ # using coxph our random factor MUST be name cluster
                                   All + frailty(cluster), # we can try to make a hazard ratio plot with these data
                                 data = survival_4_15, x=TRUE)

?frailty
coxme_test.mixed.int   <- coxme(Surv(Day, Count_dead) ~ # using coxme, notice ther results are the same as coxpH
                                   All + (1 | Tank), # note we cannot make a hazrd ratio plot using coxme
                                 data = survival_4_15)

coxme_test.mixed.int.table   <- coxme(Surv(Day, Count_dead) ~ # using coxme, notice ther results are the same as coxpH
                                   All + (1 | Tank), # note we cannot make a hazrd ratio plot using coxme
                                 data = survival_4_15) %>%  
                             tbl_regression(exp = TRUE) 
# Model:  Surv(Day, Count_dead) ~ All + (1 | Tank) 
# Fixed coefficients
#                        coef exp(coef)  se(coef)     z      p
# AllHighLowLow   -0.13606137 0.8727891 0.3095205 -0.44 0.6600
# AllHighHighHigh  0.06398801 1.0660796 0.3095165  0.21 0.8400
# AllHighHighLow   0.15633580 1.1692188 0.3095165  0.51 0.6100
# AllLowLowHigh    0.36482815 1.4402665 0.3095141  1.18 0.2400
# AllLowLowLow     0.35578059 1.4272944 0.3095146  1.15 0.2500
# AllLowHighHigh   0.70397707 2.0217775 0.3095149  2.27 0.0230
# AllLowHighLow    1.11955953 3.0635045 0.3095176  3.62 0.0003
# 
# Random effects
#  Group Variable  Std Dev   Variance 
#  Tank  Intercept 0.3790472 0.1436767


coxme_test.mixed.add        <- coxme(Surv(Day, Count_dead) ~ # using coxme, notice ther results are the same as coxpH
                                   Salinity+OA+Temp + (1 | Tank), # note we cannot make a hazrd ratio plot using coxme
                                 data = survival_4_15)

coxme_test.mixed.add.table  <- coxme(Surv(Day, Count_dead) ~ # using coxme, notice ther results are the same as coxpH
                                   Salinity+OA+Temp + (1 | Tank), # note we cannot make a hazrd ratio plot using coxme
                                 data = survival_4_15) %>%  
                             tbl_regression(exp = TRUE) 


Exp6_hazardratio_plotMIXED <- survival_4_15 %>% # using finalfit NO random factor here
                                hr_plot(dependent_os, explanatory)
# label       levels           all          HR (univariable) 
#            All  HighLowHigh 185912 (12.6)                        
#                  HighLowLow 193131 (13.0) 0.92 (0.92-0.93, p<0.001)
#                HighHighHigh 189017 (12.8) 1.06 (1.05-1.06, p<0.001)
#                 HighHighLow 191955 (13.0) 1.16 (1.15-1.17, p<0.001)
#                  LowLowHigh 191592 (12.9) 1.42 (1.41-1.43, p<0.001)  
#                   LowLowLow 193881 (13.1) 1.41 (1.40-1.42, p<0.001)  
#                 LowHighHigh 176791 (11.9) 1.79 (1.77-1.80, p<0.001)   
#                  LowHighLow 158739 (10.7) 2.26 (2.25-2.28, p<0.001)   
#  frailty(Tank) 
 

 # hazard plots
hazardratio_plot_all <- ggforest(coxph_test_all, data = survival_4_15)

hazardratio_plot     <- ggforest(coxph_test, data = survival_4_15)

library(ggpubr)
ggarrange(hazardratio_plot_all,hazardratio_plot, ncol = 2)


# output yo stuff homie!
capture.output(coxph_test.mixed,file="Output/Survival/Survival_CoxReg_mixedmodel.doc")

pdf("Output/Survival/HazardRatio_plotsl.pdf", width = 12, height = 6) # three figures
ggarrange(hazardratio_plot_all,hazardratio_plot, ncol = 2)
dev.off()



```






# Survival STATS PERMANOVA (by time point)

```{r PERMANOVA prep n' plot all data}

All_Survival <- Survival_data %>% 
                dplyr::select(Day,Id.,Survival,OA,Salinity,Temp) %>% 
                dplyr::rename(sample.id = Id.)
All_Survival$sample.id <- as.character(All_Survival$sample.id)

All_Survival_boxplot <- ggplot(data=All_Survival, 
                             aes(x=fct_relevel(Salinity, c("Low", "High")), 
                                 y=Survival, 
                                 colour=fct_relevel(OA, c("High", "Low")), 
                                 linetype= fct_relevel(Temp, c("Low", "High")))) +
                             # scale_linetype(c("dotted","solid")) +
                             scale_linetype_manual(breaks=c("Low", "High"), values=c("dashed","solid")) +
                             scale_colour_manual(breaks=c("Low", "High"), values=c("#56B4E9","#E69F00")) +
                             geom_point(aes(colour = fct_relevel(OA, c("High", "Low"))), 
                                        position = position_dodge2(width = 0.75)) + 
                             stat_summary(fun.y="mean", size = 0.8,
                                          position = position_dodge2(width = 1)) +
                             stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                          fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                          geom = 'errorbar', 
                                          position = position_dodge2(width = 1)) +
                             labs(title="Survival data", x ="Salinity", y = "Larvae size (Î¼m)") +
                             theme_classic() +
                             theme(panel.grid.major = element_blank(), 
                                   panel.grid.minor = element_blank(), 
                                   axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                                   axis.text=element_text(size=12),
                                  legend.position="none") +
                             facet_wrap(~Day, scales = "free_y")
All_Survival_boxplot

pdf("Output/Survival/plots/Survival_all_MeanSE.pdf", width=11, height=8)
print(All_Survival_boxplot)
dev.off()

```


* metadata dataframes - ommit the DV
```{r, metadata}

# METADATA
D1_metadata  <- All_Survival %>% filter(Day=="1") %>% dplyr::select(-Survival)
D4_metadata  <- All_Survival %>% filter(Day=="4") %>% dplyr::select(-Survival)
D8_metadata  <- All_Survival %>% filter(Day=="8") %>% dplyr::select(-Survival)
D11_metadata <- All_Survival %>% filter(Day=="11") %>% dplyr::select(-Survival)
D15_metadata <- All_Survival %>% filter(Day=="15") %>% dplyr::select(-Survival)
D18_metadata <- All_Survival %>% filter(Day=="18") %>% dplyr::select(-Survival)
```


* call only the DV, compute euclidean distance matrix (ideal for continuous data)
```{r, eclidean distance matrix}
# CALL JUST THE LENGTH DATA TO COMPUTE DISTANCE MATRIX
D1_surv           <- (All_Survival %>% filter(Day=="1"))[, 'Survival', drop = FALSE]
D1_distance_euc   <- vegdist(D1_surv, "euclidean")

D4_surv           <- (All_Survival %>% filter(Day=="4"))[, 'Survival', drop = FALSE]
D4_distance_euc   <- vegdist(D4_surv, "euclidean")

D8_surv           <- (All_Survival %>% filter(Day=="8"))[, 'Survival', drop = FALSE]
D8_distance_euc   <- vegdist(D8_surv, "euclidean")

D11_surv           <- (All_Survival %>% filter(Day=="11"))[, 'Survival', drop = FALSE]
D11_distance_euc   <- vegdist(D11_surv, "euclidean")

D15_surv           <- (All_Survival %>% filter(Day=="15"))[, 'Survival', drop = FALSE]
D15_distance_euc   <- vegdist(D15_surv, "euclidean")

D18_surv           <- (All_Survival %>% filter(Day=="18"))[, 'Survival', drop = FALSE]
D18_distance_euc   <- vegdist(D18_surv, "euclidean")

```


* convert to square matrix (column and row names as sample ID)
```{r, square the eclidean distance matrix}
# CREATE SQUARE MATRIX ASSIGN ROW NAMES AND COLUMN NAMES AS THE GROUP VAR
D1_distance_mtx           <- as.matrix(D1_distance_euc)
rownames(D1_distance_mtx) <- (All_Survival %>% filter(Day=="1"))$sample.id
colnames(D1_distance_mtx) <- (All_Survival %>% filter(Day=="1"))$sample.id

D4_distance_mtx           <- as.matrix(D4_distance_euc)
rownames(D4_distance_mtx) <- (All_Survival %>% filter(Day=="4"))$sample.id
colnames(D4_distance_mtx) <- (All_Survival %>% filter(Day=="4"))$sample.id

D8_distance_mtx           <- as.matrix(D8_distance_euc)
rownames(D8_distance_mtx) <- (All_Survival %>% filter(Day=="8"))$sample.id
colnames(D8_distance_mtx) <- (All_Survival %>% filter(Day=="8"))$sample.id

D11_distance_mtx           <- as.matrix(D11_distance_euc)
rownames(D11_distance_mtx) <- (All_Survival %>% filter(Day=="11"))$sample.id
colnames(D11_distance_mtx) <- (All_Survival %>% filter(Day=="11"))$sample.id

D15_distance_mtx           <- as.matrix(D15_distance_euc)
rownames(D15_distance_mtx) <- (All_Survival %>% filter(Day=="15"))$sample.id
colnames(D15_distance_mtx) <- (All_Survival %>% filter(Day=="15"))$sample.id

D18_distance_mtx           <- as.matrix(D18_distance_euc)
rownames(D18_distance_mtx) <- (All_Survival %>% filter(Day=="18"))$sample.id
colnames(D18_distance_mtx) <- (All_Survival %>% filter(Day=="18"))$sample.id

# Then...
# CONVERT THE ROWNAME TO FIRST COLUMN, CONVERT TO DATAFRAME TO DO SO
D1_distance  <- tibble::rownames_to_column(as.data.frame(D1_distance_mtx), "sample.id")
D4_distance  <- tibble::rownames_to_column(as.data.frame(D4_distance_mtx), "sample.id")
D8_distance  <- tibble::rownames_to_column(as.data.frame(D8_distance_mtx), "sample.id")
D11_distance <- tibble::rownames_to_column(as.data.frame(D11_distance_mtx), "sample.id")
D15_distance <- tibble::rownames_to_column(as.data.frame(D15_distance_mtx), "sample.id")
D18_distance <- tibble::rownames_to_column(as.data.frame(D18_distance_mtx), "sample.id")

```


* join the metadata tothe distance matrices - for the RHS (IVs) of adonis!
```{r, inner join - used for independent variable calls}

# NOW USE INNER_JOIN TO MERGE THE METADATA 
D1_meta_distance  <- inner_join(D1_distance,  D1_metadata, by = "sample.id")
D4_meta_distance  <- inner_join(D4_distance,  D4_metadata, by = "sample.id")
D8_meta_distance  <- inner_join(D8_distance,  D8_metadata, by = "sample.id")
D11_meta_distance <- inner_join(D11_distance, D11_metadata, by = "sample.id")
D15_meta_distance <- inner_join(D15_distance, D15_metadata, by = "sample.id")
D18_meta_distance <- inner_join(D18_distance, D18_metadata, by = "sample.id")

```


* isolate the distance data - for the LHS (DV) of adonis!
```{r, isolate the dependent variable dist data}
# get the dist matrix
D1_dist  <- D1_meta_distance  %>% dplyr::select(all_of(D1_meta_distance$sample.id)) %>% as.dist() 
D4_dist  <- D4_meta_distance  %>% dplyr::select(all_of(D4_meta_distance$sample.id)) %>% as.dist() 
D8_dist  <- D8_meta_distance  %>% dplyr::select(all_of(D8_meta_distance$sample.id)) %>% as.dist() 
D11_dist <- D11_meta_distance %>% dplyr::select(all_of(D11_meta_distance$sample.id)) %>% as.dist() 
D15_dist <- D15_meta_distance %>% dplyr::select(all_of(D15_meta_distance$sample.id)) %>% as.dist() 
D18_dist <- D18_meta_distance %>% dplyr::select(all_of(D18_meta_distance$sample.id)) %>% as.dist() 
```

* Finally the time is here... Lets run it!
* run adonis for eudlidean dist length by OA * Temp * Salinty
* Notes: run within each day from the mean length per tank replicate (A, B, C) with 1000 permutations,
we day 19 data has only 5 tanks remaining with length measurements, just completed for days between 1-15
```{r, run adonis2 }
# RUN ADONIS
# formula as () LHS (disc required!) ~ RHS (your metadata), data = metadata, perms)
D1_adonis_run   <- adonis2(D1_dist  ~ OA*Temp*Salinity, data=D1_meta_distance, perms = permutations) 
D4_adonis_run   <- adonis2(D4_dist  ~ OA*Temp*Salinity, data=D4_meta_distance, perms = permutations) 
D8_adonis_run   <- adonis2(D8_dist  ~ OA*Temp*Salinity, data=D8_meta_distance, perms = permutations) 
D11_adonis_run  <- adonis2(D11_dist ~ OA*Temp*Salinity, data=D11_meta_distance, perms = permutations) 
D15_adonis_run  <- adonis2(D15_dist ~ OA*Temp*Salinity, data=D15_meta_distance, perms = permutations) 
D18_adonis_run  <- adonis2(D18_dist ~ OA*Temp*Salinity, data=D18_meta_distance, perms = permutations) 

write.csv(as.data.frame(D1_adonis_run), "Output/Survival/stats_tables/D1_PERMANOVA.csv")# write
write.csv(as.data.frame(D4_adonis_run), "Output/Survival/stats_tables/D4_PERMANOVA.csv")# write
write.csv(as.data.frame(D8_adonis_run), "Output/Survival/stats_tables/D8_PERMANOVA.csv")# write
write.csv(as.data.frame(D11_adonis_run), "Output/Survival/stats_tables/D11_PERMANOVA.csv")# write
write.csv(as.data.frame(D15_adonis_run), "Output/Survival/stats_tables/D15_PERMANOVA.csv")# write
write.csv(as.data.frame(D18_adonis_run), "Output/Survival/stats_tables/D18_PERMANOVA.csv")# write
```

* day 1 
```{r, cases day 1 adonis2}
# CASES TO FOLLOW INTERACTION TERMS
D1_adonis_run # we see main effects of OA, Temp and Salinity and interaction OA:Salinity
# CREATE AN OA_SALINITY COLUMN
D1_meta_distance  <- D1_meta_distance %>% dplyr::mutate(OA_Salinity = paste0(OA,' x ',Salinity))
# TRUNCATE THE DATA FOR EACH PAIR BASED ON OA AND SALINITY, WITH UNIQUE TITLE
# Note: two two-factor variables == 6 possible pairs 
# METADATA (IV)
D1_HH_LL_metadata <- D1_meta_distance %>% dplyr::filter(OA_Salinity %in% c('High x High', 'Low x Low'))
D1_HH_LH_metadata <- D1_meta_distance %>% dplyr::filter(OA_Salinity %in% c('High x High', 'Low x High'))
D1_HH_HL_metadata <- D1_meta_distance %>% dplyr::filter(OA_Salinity %in% c('High x High', 'High x Low'))
D1_HL_LH_metadata <- D1_meta_distance %>% dplyr::filter(OA_Salinity %in% c('High x Low', 'Low x High'))
D1_HL_LL_metadata <- D1_meta_distance %>% dplyr::filter(OA_Salinity %in% c('High x Low', 'Low x Low'))
D1_LH_LL_metadata <- D1_meta_distance %>% dplyr::filter(OA_Salinity %in% c('Low x High', 'Low x Low'))
# DISTANCE (DV)
D1_HH_LL_dist     <- D1_meta_distance %>% 
  dplyr::filter(sample.id %in% D1_HH_LL_metadata$sample.id) %>% 
  dplyr::select(D1_HH_LL_metadata$sample.id) %>% 
  as.dist() 
D1_HH_LH_dist     <- D1_meta_distance %>% 
  dplyr::filter(sample.id %in% D1_HH_LH_metadata$sample.id) %>% 
  dplyr::select(D1_HH_LH_metadata$sample.id) %>% 
  as.dist() 
D1_HH_HL_dist     <- D1_meta_distance %>% 
  dplyr::filter(sample.id %in% D1_HH_HL_metadata$sample.id) %>% 
  dplyr::select(D1_HH_HL_metadata$sample.id) %>% 
  as.dist() 
D1_HL_LH_dist     <- D1_meta_distance %>% 
  dplyr::filter(sample.id %in% D1_HL_LH_metadata$sample.id) %>% 
  dplyr::select(D1_HL_LH_metadata$sample.id) %>% 
  as.dist() 
D1_HL_LL_dist     <- D1_meta_distance %>% 
  dplyr::filter(sample.id %in% D1_HL_LL_metadata$sample.id) %>% 
  dplyr::select(D1_HL_LL_metadata$sample.id) %>% 
  as.dist() 
D1_LH_LL_dist     <- D1_meta_distance %>% 
  dplyr::filter(sample.id %in% D1_LH_LL_metadata$sample.id) %>% 
  dplyr::select(D1_LH_LL_metadata$sample.id) %>% 
  as.dist()

# RUN ADONIS FOR EACH PAIR
D1_adonis_HH_LL   <- adonis2(D1_HH_LL_dist  ~ OA_Salinity, data=D1_HH_LL_metadata, perms = permutations) # nope
D1_adonis_HH_LH   <- adonis2(D1_HH_LH_dist  ~ OA_Salinity, data=D1_HH_LH_metadata, perms = permutations) # nope
D1_adonis_HH_HL   <- adonis2(D1_HH_HL_dist  ~ OA_Salinity, data=D1_HH_HL_metadata, perms = permutations) # nope
D1_adonis_HL_LH   <- adonis2(D1_HL_LH_dist  ~ OA_Salinity, data=D1_HL_LH_metadata, perms = permutations) # nope
D1_adonis_HL_LL   <- adonis2(D1_HL_LL_dist  ~ OA_Salinity, data=D1_HL_LL_metadata, perms = permutations) # yup
D1_adonis_LH_LL   <- adonis2(D1_LH_LL_dist  ~ OA_Salinity, data=D1_LH_LL_metadata, perms = permutations) # nope

# plot with letters - dotted line = low temperature, red = low salinity
age_1 <- All_Survival %>%
          filter(Day=="1")
Age1_Survival_Boxplot <- ggplot(data=age_1, 
                                 aes(x=fct_relevel(Salinity, c("Low", "High")), 
                                 y=Survival, 
                                 colour=fct_relevel(OA, c("High", "Low")), 
                                 linetype= fct_relevel(Temp, c("Low", "High")))) +
                             # scale_linetype(c("dotted","solid")) +
                             scale_linetype_manual(breaks=c("Low", "High"), values=c("dashed","solid")) +
                             scale_colour_manual(breaks=c("Low", "High"), values=c("#56B4E9","#E69F00")) +
                             geom_point(aes(colour = fct_relevel(OA, c("High", "Low"))), 
                                        position = position_dodge2(width = 0.75)) + 
                             stat_summary(fun.y="mean", size = 0.8,
                                          position = position_dodge2(width = 1)) +
                             stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                          fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                          geom = 'errorbar', 
                                          position = position_dodge2(width = 1)) +
                             labs(title="Survival data", x ="Salinity", y = "Larvae size (Î¼m)") +
                             theme_classic() +
                             theme(panel.grid.major = element_blank(), 
                                   panel.grid.minor = element_blank(), 
                                   axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                                   axis.text=element_text(size=12),
                                  legend.position="none") 


age1_pCO2_meanSE <- age_1 %>% 
                      dplyr::select(OA,Survival) %>% 
                      dplyr::group_by(OA) %>% 
                      dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n())))
# High	0.4250463	0.08458204	0.02441673	
# Low	0.4938117	0.08239617	0.02378573
((0.4938117-0.4250463)/0.4938117)*100 # 13.92543 % higher survival under low pCO2
age1_Temp_meanSE <- age_1 %>% 
                      dplyr::select(Temp,Survival) %>% 
                      dplyr::group_by(Temp) %>% 
                      dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n())))
# High	0.5105556	0.06313277	0.01822486	
# Low	0.4083025	0.08266608	0.02386364	
((0.5105556-0.4083025)/0.5105556)*100 # 20.02781 % higher survival under high temperature
age1_OASalinity_meanSE <- age_1 %>% 
                      dplyr::mutate(OA_Salinity = paste0(OA,"_x_",Salinity)) %>% 
                      dplyr::select(OA_Salinity,Survival) %>% 
                      dplyr::group_by(OA_Salinity) %>% 
                      dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n())))
# High_x_High	0.4682407	0.06943548	0.02834692	
# High_x_Low	0.3818519	0.08024935	0.03276166	
# Low_x_High	0.4781481	0.09188739	0.03751287	
# Low_x_Low	0.5094753	0.07683721	0.03136866

((0.5094753-0.3818519)/0.5094753)*100 # 25.04997% lower survival under high pCO2 low sal than low pCO2 low sal
```
 

### Age 24 hours ALL DATA ------------

```{r SURVIVAL Age 24 hours - all data}
age_1 <- All_Survival %>%
          filter(Day=="1")

# PERMANOVA - Resp_APRIL multivariate anova 
D1_surv_metadata      <- age_1 %>% dplyr::select(-Survival) # ONLY IVs AND THE UNIQUE IDENTIFIER TO JOIN LATER
D1_surv               <- age_1[, 'Survival', drop = FALSE] # CALL THE DEPENDENT VAR
D1_surv_distance_euc  <- vegdist(D1_surv, "euclidean") # EUCLIDEAN DISTNACE FOR CONTINUOUS VARIABLES
D1_surv_distance_mtx  <- as.matrix(D1_surv_distance_euc)
rownames(D1_surv_distance_mtx) <- age_1$sample.id # SQUARE RE MATRIX WITH UNIQUE IDENTIFIER FOR EACH INDIVIDUAL
colnames(D1_surv_distance_mtx) <- age_1$sample.id# SQUARE MATRIX WITH UNIQUE IDENTIFIER FOR EACH INDIVIDUAL
D1_surv_distance               <- tibble::rownames_to_column(as.data.frame(D1_surv_distance_mtx), "sample.id")
D1_surv_meta_distance          <- inner_join(D1_surv_metadata,D1_surv_distance, by = "sample.id") # JOIN BASED ON UNIQUE IDENTIFIER
D1_surv_dist                   <- D1_surv_meta_distance  %>% dplyr::select(all_of(D1_surv_meta_distance$sample.id)) %>% as.dist() 
adonis_run                <- adonis2(D1_surv_dist  ~ OA*Temp*Salinity, data=D1_surv_meta_distance, perms = 1000) 
adonis_run


# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_1)
pander(anova(Age1_Survival_lme_mod), style='rmarkdown') # anova table of lmer
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  16   |  1835   |     0     |
# |        **OA**        |   1   |  16   |  10.28  | 0.005513  | *
# |     **Salinity**     |   1   |  16   |  1.647  |  0.2176   |
# |       **Temp**       |   1   |  16   |  22.72  | 0.0002102 | *
# |   **OA:Salinity**    |   1   |  16   |  7.528  |  0.01442  | *
# |     **OA:Temp**      |   1   |  16   |  2.487  |  0.1344   |
# |  **Salinity:Temp**   |   1   |  16   |  2.07   |  0.1695   |
# | **OA:Salinity:Temp** |   1   |  16   |  3.096  |  0.09758  |
leveneTest(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # 0.8279- pass
boxplot(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lme_mod)) # check for normality of residuals - looks okay



Age1_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_1)
shapiro.test(residuals(Age1_Survival_lm_mod)) #0.156
leveneTest(residuals(Age1_Survival_lm_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # 0.8279- pass
boxplot(residuals(Age1_Survival_lm_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lm_mod)) # check for normality of residuals - looks okay
pander(anova(Age1_Survival_lm_mod), style='rmarkdown') # anova table of lmr
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)   |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:---------:|
# |        **OA**        | 1  | 0.02837  | 0.02837  |  10.28  | 0.005513  |
# |     **Salinity**     | 1  | 0.004548 | 0.004548 |  1.647  |  0.2176   |
# |       **Temp**       | 1  | 0.06273  | 0.06273  |  22.72  | 0.0002102 |
# |   **OA:Salinity**    | 1  | 0.02079  | 0.02079  |  7.528  |  0.01442  |
# |     **OA:Temp**      | 1  | 0.006866 | 0.006866 |  2.487  |  0.1344   |
# |  **Salinity:Temp**   | 1  | 0.005716 | 0.005716 |  2.07   |  0.1695   |
# | **OA:Salinity:Temp** | 1  | 0.008549 | 0.008549 |  3.096  |  0.09758  |
# |    **Residuals**     | 16 | 0.04418  | 0.002761 |   NA    |    NA     |



# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age1_Survival_lm_mod, pairwise~OA:Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
#  OA   Salinity emmean     SE df lower.CL upper.CL .group
#  High Low       0.382 0.0215 16    0.336    0.427  a    
#  High High      0.468 0.0215 16    0.423    0.514   b   
#  Low  High      0.478 0.0215 16    0.433    0.524   b   
#  Low  Low       0.509 0.0215 16    0.464    0.555   b 



# plot the data  ----------------------------------------------------------------------------------------------------- #
Age1_Survival_Boxplot_2 <- age_1 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, 
                                                ymax = mean_surv + se_surv,
                                                fill = fct_relevel(Salinity, c("Low", "High"))), 
                                                width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs_MeanSE.pdf", width=8, height=6)
print(Age1_Survival_Boxplot_2)
dev.off()

Age1_Survival_Boxplot <-ggplot(data=age_1, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+                                         # ylim(0.2,0.6) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 24 hours (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs.pdf", width=8, height=6)
print(Age1_Survival_Boxplot)
dev.off()
```


### Age 24 hours HIGH TEMP ONLY ------------

```{r, SURVIVAL Age 24 hours - HIGH TEMP ONLY}
age_1_hightemp <- Survival_dat %>%
                      filter(Day=="1") %>% 
                      dplyr::filter(Temp %in% 'High')


# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1_Survival_lme_mod_hightemp <- lme(Survival~OA*Salinity,random=~1|random_fact,data=age_1_hightemp)
pander(anova(Age1_Survival_lme_mod_hightemp), style='rmarkdown') # anova table of lmer
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |   8   |  2296   | 3.977e-11 |
# |     **OA**      |   1   |   8   |  23.18  |  0.00133  | * main effect of OA 
# |  **Salinity**   |   1   |   8   | 0.02447 |  0.8796   |
# | **OA:Salinity** |   1   |   8   | 0.9816  |  0.3508   |
leveneTest(residuals(Age1_Survival_lme_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # 0.5608- pass
boxplot(residuals(Age1_Survival_lme_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lme_mod_hightemp)) # check for normality of residuals - looks okay


# lm model
Age1_Survival_lm_mod_hightemp <- lm(Survival~OA*Salinity,data=age_1_hightemp)
pander(anova(Age1_Survival_lm_mod_hightemp), style='rmarkdown') # anova table of lm
# |     &nbsp;      | Df |  Sum Sq   |  Mean Sq  | F value | Pr(>F)  |
# |:---------------:|:--:|:---------:|:---------:|:-------:|:-------:|
# |     **OA**      | 1  |  0.03158  |  0.03158  |  23.18  | 0.00133 | * main effect of OA 
# |  **Salinity**   | 1  | 3.333e-05 | 3.333e-05 | 0.02447 | 0.8796  |
# | **OA:Salinity** | 1  | 0.001337  | 0.001337  | 0.9816  | 0.3508  |
# |  **Residuals**  | 8  |  0.0109   | 0.001362  |   NA    |   NA    |
shapiro.test(residuals(Age1_Survival_lm_mod_hightemp)) # 0.7963
leveneTest(residuals(Age1_Survival_lm_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # 0.5608- pass
boxplot(residuals(Age1_Survival_lm_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lm_mod_hightemp)) # check for normality of residuals - looks okay


# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-lsmeans(Age1_Survival_lme_mod_hightemp, ~OA, adjust="tukey")
posthoc<-emmeans(Age1_Survival_lme_mod_hightemp, pairwise~OA, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   emmean     SE df lower.CL upper.CL .group
 # High  0.459 0.0151  8    0.425    0.494  a    
 # Low   0.562 0.0151  8    0.527    0.597   b 



# plot the data  ----------------------------------------------------------------------------------------------------- #



Age1_Survival_Boxplot_2 <- age_1_hightemp %>% 
  dplyr::group_by(OA,Salinity) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High"))))+
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High"))), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, 
                                                ymax = mean_surv + se_surv,
                                                fill = fct_relevel(Salinity, c("Low", "High"))), 
                                                width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                                                axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0)) +
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs_MeanSE_hightemp.pdf", width=8, height=6)
print(Age1_Survival_Boxplot_2)
dev.off()
 
Age1_Survival_Boxplot <-ggplot(data=age_1_hightemp, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+                                         # ylim(0.2,0.6) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 24 hours (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs_hightemp.pdf", width=8, height=6)
print(Age1_Survival_Boxplot)
dev.off()

```



### Age 4 days ALL DATA  ------------

```{r, SURVIVAL Age 4 days - all data}
age_4<- Survival_dat%>%
  filter(Day=="4") %>% 
  arrange(Survival) 


# Age 4 Length mod - all data -------------------------------------------------------------------------------------- #


Age4_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_4)
pander(anova(Age4_Survival_lme_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  16   |  188.3  | 2.878e-10 |
# |        **OA**        |   1   |  16   |  1.342  |  0.2638   |
# |     **Salinity**     |   1   |  16   |  9.182  | 0.007963  | * 
# |       **Temp**       |   1   |  16   |  3.637  |  0.07464  | 
# |   **OA:Salinity**    |   1   |  16   | 0.5783  |   0.458   |
# |     **OA:Temp**      |   1   |  16   |  1.396  |  0.2546   |
# |  **Salinity:Temp**   |   1   |  16   | 0.06036 |   0.809   |
# | **OA:Salinity:Temp** |   1   |  16   | 0.2301  |   0.638   |
leveneTest(residuals(Age4_Survival_lme_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # 0.712 pass
boxplot(residuals(Age4_Survival_lme_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # visual of residuals grouped
qqnorm(resid(Age4_Survival_lme_mod)) # check for normality of residuals - looks okay


# run mod (lm model) 
Age4_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_4)
pander(anova(Age4_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)  |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:--------:|
# |        **OA**        | 1  | 0.04084  | 0.04084  |  1.342  |  0.2638  |
# |     **Salinity**     | 1  |  0.2795  |  0.2795  |  9.182  | 0.007963 |
# |       **Temp**       | 1  |  0.1107  |  0.1107  |  3.637  | 0.07464  |
# |   **OA:Salinity**    | 1  |  0.0176  |  0.0176  | 0.5783  |  0.458   |
# |     **OA:Temp**      | 1  |  0.0425  |  0.0425  |  1.396  |  0.2546  |
# |  **Salinity:Temp**   | 1  | 0.001837 | 0.001837 | 0.06036 |  0.809   |
# | **OA:Salinity:Temp** | 1  | 0.007004 | 0.007004 | 0.2301  |  0.638   |
# |    **Residuals**     | 16 |  0.4871  | 0.03044  |   NA    |    NA    |
library(stats)
shapiro.test(residuals(Age4_Survival_lm_mod)) # 0.2763 pass
leveneTest(residuals(Age4_Survival_lm_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # 0.712 pass
boxplot(residuals(Age4_Survival_lm_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # visual of residuals grouped
qqnorm(resid(Age4_Survival_lm_mod)) # check for normality of residuals - looks okay





# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age4_Survival_lm_mod, pairwise~Salinity, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
# Salinity emmean     SE df lower.CL upper.CL .group
#  Low       0.381 0.0504 16    0.274    0.488  a    
#  High      0.597 0.0504 16    0.490    0.703   b 
#36.1% higher under high salinity

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age4_Survival_Boxplot_2 <- age_4 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 4 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_4days_MeanSE.pdf", width=4, height=6)
print(Age4_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age4_Survival_Boxplot <-ggplot(data=age_4, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 4 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_4days.pdf", width=4, height=6)
print(Age4_Survival_Boxplot)
dev.off()

```


### Age 8 days ALL DATA  ------------

```{r, SURVIVAL Age 8 days - all data}
age_8<- Survival_dat%>%
  filter(Day=="8") %>% 
  arrange(Survival) %>% 
  mutate(Survival = ifelse(Survival == last(Survival), 0.75, Survival)) # ID #12 was 0.86 -  whereas survival on day 4 was 0.75 - this is an artifact of increased numbers? I changed to 0.75 to reflect no losses between days 4 and 8


# Age 8 Length mod - all data -------------------------------------------------------------------------------------- #


Age8_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_8)
pander(anova(Age8_Survival_lme_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  16   |  46.08  | 4.355e-06 |
# |        **OA**        |   1   |  16   | 0.3291  |  0.5742   |
# |     **Salinity**     |   1   |  16   |  14.26  | 0.001652  | *
# |       **Temp**       |   1   |  16   |  0.028  |  0.8692   |
# |   **OA:Salinity**    |   1   |  16   |  0.112  |  0.7422   |
# |     **OA:Temp**      |   1   |  16   | 0.06913 |   0.796   |
# |  **Salinity:Temp**   |   1   |  16   | 0.1651  |  0.6899   |
# | **OA:Salinity:Temp** |   1   |  16   | 0.4805  |  0.4981   |
leveneTest(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # 0.41 pass
boxplot(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # visual of residuals grouped
qqnorm(resid(Age8_Survival_lme_mod)) # check for normality of residuals - looks okay


# run mod (lm model) 
Age8_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_8)
pander(anova(Age8_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)  |
# |:--------------------:|:--:|:---------:|:---------:|:-------:|:--------:|
# |        **OA**        | 1  |  0.0096   |  0.0096   | 0.3291  |  0.5742  |
# |     **Salinity**     | 1  |  0.4161   |  0.4161   |  14.26  | 0.001652 | *
# |       **Temp**       | 1  | 0.0008167 | 0.0008167 |  0.028  |  0.8692  |
# |   **OA:Salinity**    | 1  | 0.003267  | 0.003267  |  0.112  |  0.7422  |
# |     **OA:Temp**      | 1  | 0.002017  | 0.002017  | 0.06913 |  0.796   |
# |  **Salinity:Temp**   | 1  | 0.004817  | 0.004817  | 0.1651  |  0.6899  |
# | **OA:Salinity:Temp** | 1  |  0.01402  |  0.01402  | 0.4805  |  0.4981  |
# |    **Residuals**     | 16 |  0.4667   |  0.02917  |   NA    |    NA    |
library(stats)
shapiro.test(residuals(Age8_Survival_lm_mod)) # 0.1911 pass
leveneTest(residuals(Age8_Survival_lm_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # 0.41 pass
boxplot(residuals(Age8_Survival_lm_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # visual of residuals grouped
qqnorm(resid(Age8_Survival_lm_mod)) # check for normality of residuals - looks okay





# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age8_Survival_lm_mod, pairwise~Salinity, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # Salinity emmean     SE df lower.CL upper.CL .group
 # Low       0.105 0.0493 16  0.00048    0.210  a    
 # High      0.368 0.0493 16  0.26381    0.473   b  
#71.4% higher under high salinity

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age8_Survival_Boxplot_2 <- age_8 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 8 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_8days_MeanSE.pdf", width=8, height=6)
print(Age8_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age8_Survival_Boxplot <-ggplot(data=age_8, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 24 hours (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_8days.pdf", width=8, height=6)
print(Age8_Survival_Boxplot)
dev.off()

```




### Age 11 days ALL DATA  ------------

```{r, SURVIVAL Age 11 days - all data}
age_11<- Survival_dat%>%
  filter(Day=="11") %>% 
  arrange(Survival)


# Age 11 Length mod - all data -------------------------------------------------------------------------------------- #

library(stats)
# run mod (lm model) 
Age11_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_11)
shapiro.test(residuals(Age11_Survival_lm_mod)) # 0.405 pass
leveneTest(residuals(Age11_Survival_lm_mod) ~ age_11$Temp*age_11$OA*age_11$Salinity) # 0.5766 pass
pander(anova(Age11_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)  |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:--------:|
# |        **OA**        | 1  | 0.01205  | 0.01205  |  0.837  |  0.3739  |
# |     **Salinity**     | 1  |  0.1701  |  0.1701  |  11.82  | 0.003379 |
# |       **Temp**       | 1  |  0.0121  |  0.0121  | 0.8404  |  0.3729  |
# |   **OA:Salinity**    | 1  | 0.007663 | 0.007663 | 0.5324  |  0.4762  |
# |     **OA:Temp**      | 1  | 0.002046 | 0.002046 | 0.1421  |  0.7111  |
# |  **Salinity:Temp**   | 1  | 0.002264 | 0.002264 | 0.1573  |  0.6969  |
# | **OA:Salinity:Temp** | 1  | 0.005744 | 0.005744 | 0.3991  |  0.5365  |
# |    **Residuals**     | 16 |  0.2303  | 0.01439  |   NA    |    NA    |
boxplot(residuals(Age11_Survival_lm_mod) ~ age_11$Temp*age_11$OA*age_11$Salinity) # visual of residuals grouped
qqnorm(resid(Age11_Survival_lm_mod)) # check for normality of residuals - looks okay





# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age11_Survival_lm_mod, pairwise~Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # Low      0.0741 0.0346 16 0.000698    0.148  a    
 # High     0.2425 0.0346 16 0.169082    0.316   b   

((0.2425-0.0741)/0.2425)*100

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age11_Survival_Boxplot_2 <- age_11 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 11 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 


setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_11days_MeanSE.pdf", width=11, height=6)
print(Age11_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age11_Survival_Boxplot <-ggplot(data=age_11, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 11 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_11days.pdf", width=11, height=6)
print(Age11_Survival_Boxplot)
dev.off()

```


### Age 15 days ALL DATA  ------------

```{r, SURVIVAL Age 15 days - all data}
age_15<- Survival_dat%>%
  filter(Day=="15") %>% 
  arrange(Survival) 



# Age 15 Length mod - all data -------------------------------------------------------------------------------------- #

# run mod (lm model) 
Age15_Survival_lm_mod <- lm(sqrt(Survival)~OA*Salinity*Temp,data=age_15)
library(stats)
shapiro.test(residuals(Age15_Survival_lm_mod)) # 0.481 pass
leveneTest(residuals(Age15_Survival_lm_mod) ~ age_15$Temp*age_15$OA*age_15$Salinity) # 0.4767 pass
boxplot(residuals(Age15_Survival_lm_mod) ~ age_15$Temp*age_15$OA*age_15$Salinity) # visual of residuals grouped
qqnorm(resid(Age15_Survival_lm_mod)) # check for normality of residuals - looks okay

pander(anova(Age15_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)   |
# |:--------------------:|:--:|:---------:|:---------:|:-------:|:---------:|
# |        **OA**        | 1  |  0.1079   |  0.1079   |  5.869  |  0.02765  |
# |     **Salinity**     | 1  |  0.3459   |  0.3459   |  18.82  | 0.0005088 |
# |       **Temp**       | 1  |  0.08242  |  0.08242  |  4.483  |  0.05024  |
# |   **OA:Salinity**    | 1  | 0.002304  | 0.002304  | 0.1253  |  0.7279   |
# |     **OA:Temp**      | 1  | 0.0008117 | 0.0008117 | 0.04415 |  0.8362   |
# |  **Salinity:Temp**   | 1  |  0.02577  |  0.02577  |  1.402  |  0.2537   |
# | **OA:Salinity:Temp** | 1  | 0.007163  | 0.007163  | 0.3896  |  0.5413   |
# |    **Residuals**     | 16 |  0.2941   |  0.01838  |   NA    |    NA     |

# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age15_Survival_lm_mod, pairwise~Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)

 # Salinity emmean     SE df lower.CL upper.CL .group
 # Low       0.134 0.0391 16   0.0507    0.217  a    
 # High      0.374 0.0391 16   0.2908    0.457   b 
((0.374-0.134)/0.374)*100

posthoc<-emmeans(Age15_Survival_lm_mod, pairwise~OA, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   emmean     SE df lower.CL upper.CL .group
 # High  0.187 0.0391 16    0.104    0.270  a    
 # Low   0.321 0.0391 16    0.238    0.404   b   
((0.321-0.187)/0.321)*100

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age15_Survival_Boxplot_2 <- age_15 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 15 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_15days_MeanSE.pdf", width=15, height=6)
print(Age15_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age15_Survival_Boxplot <-ggplot(data=age_15, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 15 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_15days.pdf", width=15, height=6)
print(Age15_Survival_Boxplot)
dev.off()

```


### Age 18 days ALL DATA  ------------

```{r, SURVIVAL Age 15 days - all data}
age_18<- Survival_dat%>%
  filter(Day=="18") %>% 
  arrange(Survival)

age_18 %>% dplyr::filter(Temp %in% 'Low' & Salinity %in% 'Low'& OA %in% 'High')
age_18 %>% dplyr::filter(Temp %in% 'High' & Salinity %in% 'Low' & OA %in% 'High')


mean((age_18 %>% dplyr::filter(Temp %in% 'Low'))$Survival*100)
sd((age_18 %>% dplyr::filter(Temp %in% 'Low'))$Survival*100)

# run mod (lm model) 
Age18_Survival_lm_mod <- lm((Survival)~OA*Salinity*Temp,data=age_18)
shapiro.test(residuals(Age18_Survival_lm_mod)) #  0.000557
hist(resid(Age18_Survival_lm_mod))

Age18_Survival_lm_mod_T <- lm(asin(sqrt(Survival))~OA*Salinity*Temp,data=age_18)
shapiro.test(residuals(Age18_Survival_lm_mod_T)) #  0.07886
leveneTest(residuals(Age18_Survival_lm_mod_T) ~ age_18$Temp*age_18$OA*age_18$Salinity) # 0.2879 pass
boxplot(residuals(Age18_Survival_lm_mod_T) ~ age_18$Temp*age_18$OA*age_18$Salinity) # visual of residuals grouped
qqnorm(resid(Age18_Survival_lm_mod_T)) # check for normality of residuals - looks okay

pander(anova(Age18_Survival_lm_mod_T), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value | Pr(>F)  |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:-------:|
# |        **OA**        | 1  | 0.08944  | 0.08944  |  7.214  | 0.01624 |
# |     **Salinity**     | 1  | 0.05461  | 0.05461  |  4.404  | 0.05207 |
# |       **Temp**       | 1  | 0.04462  | 0.04462  |  3.599  | 0.07602 |
# |   **OA:Salinity**    | 1  | 0.007922 | 0.007922 | 0.6389  | 0.4358  |
# |     **OA:Temp**      | 1  | 0.005999 | 0.005999 | 0.4838  | 0.4967  |
# |  **Salinity:Temp**   | 1  | 0.01172  | 0.01172  | 0.9457  | 0.3453  |
# | **OA:Salinity:Temp** | 1  | 0.07153  | 0.07153  |  5.77   | 0.0288  |
# |    **Residuals**     | 16 |  0.1984  |  0.0124  |   NA    |   NA    |

posthoc<-emmeans(Age18_Survival_lm_mod_T, pairwise~OA*Temp*Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)

 # OA   Temp Salinity emmean     SE df lower.CL upper.CL .group
 # High Low  Low      0.0130 0.0643 16  -0.1233    0.149  a    
 # High High Low      0.0659 0.0643 16  -0.0704    0.202  ab   
 # High Low  High     0.0797 0.0643 16  -0.0565    0.216  abc  
 # Low  Low  Low      0.0938 0.0643 16  -0.0424    0.230  abc  
 # Low  High High     0.2075 0.0643 16   0.0712    0.344   bcd 
 # High High High     0.2626 0.0643 16   0.1263    0.399    cd 
 # Low  High Low      0.3019 0.0643 16   0.1656    0.438     d 
 # Low  Low  High     0.3063 0.0643 16   0.1700    0.443     d
 # 
 
 
##Here Low Salinity treatments are in Blue
Age18_Survival_Boxplot <-ggplot(data=age_18, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 18 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

Age18_Survival_Boxplot
```
