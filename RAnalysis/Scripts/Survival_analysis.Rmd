---
title: "Survival_analysis.Rmd"
author: "Sam Gurr"
date: "11/2/2022"
output:
  pdf_document: default
  html_document: default
---




# load libraries

```{r, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
# library(multcompView)
# library(agricolae)
library(dplyr)
library(lme4)
library(ggplot2)
library(nlme)
library(car)
library(performance)
# library(stargazer)
library(emmeans)
library(pander)
# library(survminer)
library(survival)
# library(adjustedCurves)
# library(riskRegression)
# library(pammtools)
# library(bestNormalize)
```


# Set Path & load data

```{r setup}

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")

# survival data
Survival_dat <- read.csv("Data/Survival/Survival_master.csv", header = T) %>% 
                            dplyr::mutate(random_fact = paste( substr(Temp,1,1), 
                                                               substr(OA,1,1), 
                                                               substr(Salinity,1,1), '_', Replicate, sep = ''))
View(Survival_dat)
# head(Survival_dat) # view first few lines
```


# prep data 

```{r, prep the raw data for stats} 
# extract the experiment data with corresponding sample Ids from the averaged data master file...
Exp_data <-  Survival_dat %>% 
                filter(Day %in% 1) %>% 
                dplyr::select(c('Temp','OA','Salinity','Replicate','Id.', 'pH', 'AR')) %>% 
                dplyr::rename(Sample.ID = Id., Aragonite_saturation = AR)

```
 
 
 
 Plot all data
 
 
```{r survival to hatch and day 15 - for MAS presentation} 
 
######################################################## #
# Survival day 1
Survival_means_day1 <- Survival_dat %>% 
                                dplyr::filter(Day == 1) %>% 
                                na.omit() %>% 
                                dplyr::group_by(Day, OA, Salinity, Temp) %>% 
                                dplyr::summarise(mean_survival = mean(Survival), 
                                                 n           = n(),
                                                 sd_survival   = sd(Survival),
                                                 se_survival   = sd_survival/(sqrt(n))) %>%  
                                dplyr::mutate(Survival_to_hatch = (mean_survival) *100 ) %>% 
                                dplyr::mutate(OA_Sal = paste(substr(OA,1,1),
                                              substr(Salinity,1,1),
                                                  sep = ''))

Heatplot_Day1 <- Survival_means_day1 %>% 
       dplyr::mutate(Day = as.factor(Day)) %>% 
       ggplot(aes(x = Day,
                  y = mean_survival)) + 
      geom_point(color = 'black') +
      geom_line(aes(x = Day,
                    y = mean_survival)) +
      geom_errorbar(aes(ymin = mean_survival - se_survival, 
                        ymax = mean_survival + se_survival), 
                        width = 0.5, 
                        position= "dodge2") +
      geom_smooth(method = "lm", 
                  se = FALSE, 
                  size = 1, 
                  color = 'white') +
      theme_bw() +  
      theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank()) +
      facet_grid(vars(Temp), 
                 vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH")))) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/plots/Survival_hatch_facetted.pdf", width=11, height=5)
print(Heatplot_Day1)
dev.off()



```
 
```{r survival to set - days 4 to 15} 

# plot - Survival  after day 1

Survival_means <- Survival_dat %>% 
                          dplyr::filter(Day >1) %>% 
                          #na.omit() %>% 
                          dplyr::group_by(Day, OA, Salinity, Temp) %>% 
                          dplyr::summarise(mean_survival = mean(Survival), 
                                           n           = n(),
                                           sd_survival   = sd(Survival),
                                           se_survival   = sd_survival/(sqrt(n)))



Survival_to_set_means <- as.data.frame(Survival_means %>% 
  filter(Day %in% 15) %>% 
  dplyr::select(c(Day, OA, Salinity, Temp, mean_survival)) %>% 
  dplyr::group_by(OA, Salinity, Temp)  %>% 
  tidyr::spread(Day, mean_survival) %>%  # new columns titled 1 and 15 for he Age and with values for the 
  # length data grouped by treatment 
  dplyr::mutate(Survival_to_set = (`15`) *100 ) %>% 
  dplyr::select(!`15`)) 

Survival_means_MASTER <- merge(Survival_means, Survival_to_set_means, by=c('OA', 'Salinity', 'Temp')) %>% 
                              dplyr::mutate(OA_Sal = paste(substr(OA,1,1),
                                              substr(Salinity,1,1),
                                                  sep = ''))

# plot - survival

Heatplot <- Survival_means_MASTER %>% 
       ggplot(aes(x = Day,
                  y = mean_survival)) + 
       geom_rect(aes(fill = Survival_to_set), 
                   xmin = -Inf, 
                   xmax = Inf, 
                   ymin = -Inf, 
                   ymax = Inf, 
                   alpha = 0.3) +
      geom_point(color = 'black') +
      geom_line(aes(x = Day,
                    y = mean_survival)) +
      geom_errorbar(aes(ymin = mean_survival - se_survival, 
                        ymax = mean_survival + se_survival), 
                        width = 0.5, 
                        position= "dodge2") +
      geom_smooth(method = "lm", 
                  se = FALSE, 
                  size = 1, 
                  color = 'white') +
      theme_bw() +  
      theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank()) +
      facet_grid(vars(Temp), 
                 vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH")))) +
      geom_text(size = 2, 
                   aes(x = 12, 
                       y = 0.8, 
                       label = paste0(round(Survival_to_set,2),"% survival to set"))) +
      scale_fill_gradient(low = "orange", 
                           high = "forestgreen", 
                           aesthetics = "fill")
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/plots/Survival_all_facetted.pdf", width=11, height=5)
print(Heatplot)
dev.off()


Survival_all_MeanSE_plot <- Survival_means %>% 
                                dplyr::mutate(AllTreat = as.factor(paste(OA, Salinity, Temp, sep = '_'))) %>% 
                                ggplot(aes(x = as.numeric(Day),
                                           y = mean_survival, 
                                           group = AllTreat,
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_point(aes(colour = fct_relevel(Salinity, c("Low", "High")), 
                                           shape = fct_relevel(OA, c("Low", "High"))),
                                           width = 0.5,
                                           position = "dodge2") +
                                geom_line(aes(x = as.numeric(Day),
                                           y=mean_survival, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_errorbar(aes(ymin = mean_survival - se_survival, 
                                                  ymax = mean_survival + se_survival), 
                                              width = 0.5, position= "dodge2") +
                                theme_minimal() +  
                                stat_summary(geom="ribbon", fun.data=mean_cl_normal, width=0.1, conf.int=0.95, fill="lightblue")+
                                facet_wrap(~(fct_relevel(OA, c("Low", "High"))))
Survival_all_MeanSE_plot # view the plot
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_all_MeanSE.pdf", width=11, height=6)
print(Survival_all_MeanSE_plot)
dev.off()





Heatplot_day15 <- Survival_means_MASTER %>% 
  dplyr::filter(Day %in% 15) %>% 
  dplyr::mutate(Day = as.factor(Day)) %>% 
       ggplot(aes(x = Day,
                  y = mean_survival)) + 
      geom_point(color = 'black') +
      geom_line(aes(x = Day,
                    y = mean_survival)) +
      geom_errorbar(aes(ymin = mean_survival - se_survival, 
                        ymax = mean_survival + se_survival), 
                        width = 0.5, 
                        position= "dodge2") +
      geom_smooth(method = "lm", 
                  se = FALSE, 
                  size = 1, 
                  color = 'white') +
      theme_bw() +  
      theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank()) +
      facet_grid(vars(Temp), 
                 vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH")))) 
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/plots/Survival_Day15.pdf", width=11, height=5)
print(Heatplot_day15)
dev.off()




```



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Survival STATS ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


### Age 24 hours ALL DATA ------------

```{r SURVIVAL Age 24 hours - all data}
age_1<- Survival_dat %>%
          filter(Day=="1")


# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_1)
pander(anova(Age1_Survival_lme_mod), style='rmarkdown') # anova table of lmer
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  16   |  1835   |     0     |
# |        **OA**        |   1   |  16   |  10.28  | 0.005513  | *
# |     **Salinity**     |   1   |  16   |  1.647  |  0.2176   |
# |       **Temp**       |   1   |  16   |  22.72  | 0.0002102 | *
# |   **OA:Salinity**    |   1   |  16   |  7.528  |  0.01442  | *
# |     **OA:Temp**      |   1   |  16   |  2.487  |  0.1344   |
# |  **Salinity:Temp**   |   1   |  16   |  2.07   |  0.1695   |
# | **OA:Salinity:Temp** |   1   |  16   |  3.096  |  0.09758  |
leveneTest(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # 0.8279- pass
boxplot(residuals(Age1_Survival_lme_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lme_mod)) # check for normality of residuals - looks okay





Age1_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_1)
pander(anova(Age1_Survival_lm_mod), style='rmarkdown') # anova table of lmr
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)   |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:---------:|
# |        **OA**        | 1  | 0.02837  | 0.02837  |  10.28  | 0.005513  |
# |     **Salinity**     | 1  | 0.004548 | 0.004548 |  1.647  |  0.2176   |
# |       **Temp**       | 1  | 0.06273  | 0.06273  |  22.72  | 0.0002102 |
# |   **OA:Salinity**    | 1  | 0.02079  | 0.02079  |  7.528  |  0.01442  |
# |     **OA:Temp**      | 1  | 0.006866 | 0.006866 |  2.487  |  0.1344   |
# |  **Salinity:Temp**   | 1  | 0.005716 | 0.005716 |  2.07   |  0.1695   |
# | **OA:Salinity:Temp** | 1  | 0.008549 | 0.008549 |  3.096  |  0.09758  |
# |    **Residuals**     | 16 | 0.04418  | 0.002761 |   NA    |    NA     |
shapiro.test(residuals(Age1_Survival_lm_mod)) #0.156
leveneTest(residuals(Age1_Survival_lm_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # 0.8279- pass
boxplot(residuals(Age1_Survival_lm_mod) ~ age_1$Temp*age_1$OA*age_1$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lm_mod)) # check for normality of residuals - looks okay




# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age1_Survival_lme_mod, pairwise~OA:Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
#  OA   Salinity emmean     SE df lower.CL upper.CL .group
#  High Low       0.382 0.0215 16    0.336    0.427  a    
#  High High      0.468 0.0215 16    0.423    0.514   b   
#  Low  High      0.478 0.0215 16    0.433    0.524   b   
#  Low  Low       0.509 0.0215 16    0.464    0.555   b 



# plot the data  ----------------------------------------------------------------------------------------------------- #
Age1_Survival_Boxplot_2 <- age_1 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, 
                                                ymax = mean_surv + se_surv,
                                                fill = fct_relevel(Salinity, c("Low", "High"))), 
                                                width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs_MeanSE.pdf", width=8, height=6)
print(Age1_Survival_Boxplot_2)
dev.off()

Age1_Survival_Boxplot <-ggplot(data=age_1, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+                                         # ylim(0.2,0.6) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 24 hours (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs.pdf", width=8, height=6)
print(Age1_Survival_Boxplot)
dev.off()
```


### Age 24 hours HIGH TEMP ONLY ------------

```{r, SURVIVAL Age 24 hours - HIGH TEMP ONLY}
age_1_hightemp <- Survival_dat %>%
                      filter(Day=="1") %>% 
                      dplyr::filter(Temp %in% 'High')


# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1_Survival_lme_mod_hightemp <- lme(Survival~OA*Salinity,random=~1|random_fact,data=age_1_hightemp)
pander(anova(Age1_Survival_lme_mod_hightemp), style='rmarkdown') # anova table of lmer
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |   8   |  2296   | 3.977e-11 |
# |     **OA**      |   1   |   8   |  23.18  |  0.00133  | * main effect of OA 
# |  **Salinity**   |   1   |   8   | 0.02447 |  0.8796   |
# | **OA:Salinity** |   1   |   8   | 0.9816  |  0.3508   |
leveneTest(residuals(Age1_Survival_lme_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # 0.5608- pass
boxplot(residuals(Age1_Survival_lme_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lme_mod_hightemp)) # check for normality of residuals - looks okay


# lm model
Age1_Survival_lm_mod_hightemp <- lm(Survival~OA*Salinity,data=age_1_hightemp)
pander(anova(Age1_Survival_lm_mod_hightemp), style='rmarkdown') # anova table of lm
# |     &nbsp;      | Df |  Sum Sq   |  Mean Sq  | F value | Pr(>F)  |
# |:---------------:|:--:|:---------:|:---------:|:-------:|:-------:|
# |     **OA**      | 1  |  0.03158  |  0.03158  |  23.18  | 0.00133 | * main effect of OA 
# |  **Salinity**   | 1  | 3.333e-05 | 3.333e-05 | 0.02447 | 0.8796  |
# | **OA:Salinity** | 1  | 0.001337  | 0.001337  | 0.9816  | 0.3508  |
# |  **Residuals**  | 8  |  0.0109   | 0.001362  |   NA    |   NA    |
shapiro.test(residuals(Age1_Survival_lm_mod_hightemp)) # 0.7963
leveneTest(residuals(Age1_Survival_lm_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # 0.5608- pass
boxplot(residuals(Age1_Survival_lm_mod_hightemp) ~ age_1_hightemp$OA*age_1_hightemp$Salinity) # visual of residuals grouped
qqnorm(resid(Age1_Survival_lm_mod_hightemp)) # check for normality of residuals - looks okay


# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-lsmeans(Age1_Survival_lme_mod_hightemp, ~OA, adjust="tukey")
posthoc<-emmeans(Age1_Survival_lme_mod_hightemp, pairwise~OA, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   emmean     SE df lower.CL upper.CL .group
 # High  0.459 0.0151  8    0.425    0.494  a    
 # Low   0.562 0.0151  8    0.527    0.597   b 



# plot the data  ----------------------------------------------------------------------------------------------------- #



Age1_Survival_Boxplot_2 <- age_1_hightemp %>% 
  dplyr::group_by(OA,Salinity) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High"))))+
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High"))), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, 
                                                ymax = mean_surv + se_surv,
                                                fill = fct_relevel(Salinity, c("Low", "High"))), 
                                                width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              ylim(0.2,0.6) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                                                axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0)) +
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs_MeanSE_hightemp.pdf", width=8, height=6)
print(Age1_Survival_Boxplot_2)
dev.off()
 
Age1_Survival_Boxplot <-ggplot(data=age_1_hightemp, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+                                         # ylim(0.2,0.6) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 24 hours (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 
  
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_24hrs_hightemp.pdf", width=8, height=6)
print(Age1_Survival_Boxplot)
dev.off()

```



### Age 4 days ALL DATA  ------------

```{r, SURVIVAL Age 4 days - all data}
age_4<- Survival_dat%>%
  filter(Day=="4") %>% 
  arrange(Survival) 


# Age 4 Length mod - all data -------------------------------------------------------------------------------------- #


Age4_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_4)
pander(anova(Age4_Survival_lme_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  16   |  188.3  | 2.878e-10 |
# |        **OA**        |   1   |  16   |  1.342  |  0.2638   |
# |     **Salinity**     |   1   |  16   |  9.182  | 0.007963  | * 
# |       **Temp**       |   1   |  16   |  3.637  |  0.07464  | 
# |   **OA:Salinity**    |   1   |  16   | 0.5783  |   0.458   |
# |     **OA:Temp**      |   1   |  16   |  1.396  |  0.2546   |
# |  **Salinity:Temp**   |   1   |  16   | 0.06036 |   0.809   |
# | **OA:Salinity:Temp** |   1   |  16   | 0.2301  |   0.638   |
leveneTest(residuals(Age4_Survival_lme_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # 0.712 pass
boxplot(residuals(Age4_Survival_lme_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # visual of residuals grouped
qqnorm(resid(Age4_Survival_lme_mod)) # check for normality of residuals - looks okay


# run mod (lm model) 
Age4_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_4)
pander(anova(Age4_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)  |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:--------:|
# |        **OA**        | 1  | 0.04084  | 0.04084  |  1.342  |  0.2638  |
# |     **Salinity**     | 1  |  0.2795  |  0.2795  |  9.182  | 0.007963 |
# |       **Temp**       | 1  |  0.1107  |  0.1107  |  3.637  | 0.07464  |
# |   **OA:Salinity**    | 1  |  0.0176  |  0.0176  | 0.5783  |  0.458   |
# |     **OA:Temp**      | 1  |  0.0425  |  0.0425  |  1.396  |  0.2546  |
# |  **Salinity:Temp**   | 1  | 0.001837 | 0.001837 | 0.06036 |  0.809   |
# | **OA:Salinity:Temp** | 1  | 0.007004 | 0.007004 | 0.2301  |  0.638   |
# |    **Residuals**     | 16 |  0.4871  | 0.03044  |   NA    |    NA    |
library(stats)
shapiro.test(residuals(Age4_Survival_lm_mod)) # 0.2763 pass
leveneTest(residuals(Age4_Survival_lm_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # 0.712 pass
boxplot(residuals(Age4_Survival_lm_mod) ~ age_4$Temp*age_4$OA*age_4$Salinity) # visual of residuals grouped
qqnorm(resid(Age4_Survival_lm_mod)) # check for normality of residuals - looks okay





# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age4_Survival_lm_mod, pairwise~Salinity, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
# Salinity emmean     SE df lower.CL upper.CL .group
#  Low       0.381 0.0504 16    0.274    0.488  a    
#  High      0.597 0.0504 16    0.490    0.703   b 
#36.1% higher under high salinity

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age4_Survival_Boxplot_2 <- age_4 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 4 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_4days_MeanSE.pdf", width=4, height=6)
print(Age4_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age4_Survival_Boxplot <-ggplot(data=age_4, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 4 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_4days.pdf", width=4, height=6)
print(Age4_Survival_Boxplot)
dev.off()

```


### Age 8 days ALL DATA  ------------

```{r, SURVIVAL Age 8 days - all data}
age_8<- Survival_dat%>%
  filter(Day=="8") %>% 
  arrange(Survival) %>% 
  mutate(Survival = ifelse(Survival == last(Survival), 0.75, Survival)) # ID #12 was 0.86 -  whereas survival on day 4 was 0.75 - this is an artifact of increased numbers? I changed to 0.75 to reflect no losses between days 4 and 8


# Age 8 Length mod - all data -------------------------------------------------------------------------------------- #


Age8_Survival_lme_mod <- lme(Survival~OA*Salinity*Temp,random=~1|random_fact,data=age_8)
pander(anova(Age8_Survival_lme_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  16   |  46.08  | 4.355e-06 |
# |        **OA**        |   1   |  16   | 0.3291  |  0.5742   |
# |     **Salinity**     |   1   |  16   |  14.26  | 0.001652  | *
# |       **Temp**       |   1   |  16   |  0.028  |  0.8692   |
# |   **OA:Salinity**    |   1   |  16   |  0.112  |  0.7422   |
# |     **OA:Temp**      |   1   |  16   | 0.06913 |   0.796   |
# |  **Salinity:Temp**   |   1   |  16   | 0.1651  |  0.6899   |
# | **OA:Salinity:Temp** |   1   |  16   | 0.4805  |  0.4981   |
leveneTest(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # 0.41 pass
boxplot(residuals(Age8_Survival_lme_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # visual of residuals grouped
qqnorm(resid(Age8_Survival_lme_mod)) # check for normality of residuals - looks okay


# run mod (lm model) 
Age8_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_8)
pander(anova(Age8_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)  |
# |:--------------------:|:--:|:---------:|:---------:|:-------:|:--------:|
# |        **OA**        | 1  |  0.0096   |  0.0096   | 0.3291  |  0.5742  |
# |     **Salinity**     | 1  |  0.4161   |  0.4161   |  14.26  | 0.001652 | *
# |       **Temp**       | 1  | 0.0008167 | 0.0008167 |  0.028  |  0.8692  |
# |   **OA:Salinity**    | 1  | 0.003267  | 0.003267  |  0.112  |  0.7422  |
# |     **OA:Temp**      | 1  | 0.002017  | 0.002017  | 0.06913 |  0.796   |
# |  **Salinity:Temp**   | 1  | 0.004817  | 0.004817  | 0.1651  |  0.6899  |
# | **OA:Salinity:Temp** | 1  |  0.01402  |  0.01402  | 0.4805  |  0.4981  |
# |    **Residuals**     | 16 |  0.4667   |  0.02917  |   NA    |    NA    |
library(stats)
shapiro.test(residuals(Age8_Survival_lm_mod)) # 0.1911 pass
leveneTest(residuals(Age8_Survival_lm_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # 0.41 pass
boxplot(residuals(Age8_Survival_lm_mod) ~ age_8$Temp*age_8$OA*age_8$Salinity) # visual of residuals grouped
qqnorm(resid(Age8_Survival_lm_mod)) # check for normality of residuals - looks okay





# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age8_Survival_lm_mod, pairwise~Salinity, adjust="tukey")

multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # Salinity emmean     SE df lower.CL upper.CL .group
 # Low       0.105 0.0493 16  0.00048    0.210  a    
 # High      0.368 0.0493 16  0.26381    0.473   b  
#71.4% higher under high salinity

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age8_Survival_Boxplot_2 <- age_8 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 8 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_8days_MeanSE.pdf", width=8, height=6)
print(Age8_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age8_Survival_Boxplot <-ggplot(data=age_8, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 24 hours (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_8days.pdf", width=8, height=6)
print(Age8_Survival_Boxplot)
dev.off()

```




### Age 11 days ALL DATA  ------------

```{r, SURVIVAL Age 11 days - all data}
age_11<- Survival_dat%>%
  filter(Day=="11") %>% 
  arrange(Survival)


# Age 11 Length mod - all data -------------------------------------------------------------------------------------- #

library(stats)
# run mod (lm model) 
Age11_Survival_lm_mod <- lm(Survival~OA*Salinity*Temp,data=age_11)
shapiro.test(residuals(Age11_Survival_lm_mod)) # 0.405 pass
leveneTest(residuals(Age11_Survival_lm_mod) ~ age_11$Temp*age_11$OA*age_11$Salinity) # 0.5766 pass
pander(anova(Age11_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)  |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:--------:|
# |        **OA**        | 1  | 0.01205  | 0.01205  |  0.837  |  0.3739  |
# |     **Salinity**     | 1  |  0.1701  |  0.1701  |  11.82  | 0.003379 |
# |       **Temp**       | 1  |  0.0121  |  0.0121  | 0.8404  |  0.3729  |
# |   **OA:Salinity**    | 1  | 0.007663 | 0.007663 | 0.5324  |  0.4762  |
# |     **OA:Temp**      | 1  | 0.002046 | 0.002046 | 0.1421  |  0.7111  |
# |  **Salinity:Temp**   | 1  | 0.002264 | 0.002264 | 0.1573  |  0.6969  |
# | **OA:Salinity:Temp** | 1  | 0.005744 | 0.005744 | 0.3991  |  0.5365  |
# |    **Residuals**     | 16 |  0.2303  | 0.01439  |   NA    |    NA    |
boxplot(residuals(Age11_Survival_lm_mod) ~ age_11$Temp*age_11$OA*age_11$Salinity) # visual of residuals grouped
qqnorm(resid(Age11_Survival_lm_mod)) # check for normality of residuals - looks okay





# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age11_Survival_lm_mod, pairwise~Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # Low      0.0741 0.0346 16 0.000698    0.148  a    
 # High     0.2425 0.0346 16 0.169082    0.316   b   

((0.2425-0.0741)/0.2425)*100

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age11_Survival_Boxplot_2 <- age_11 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 11 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 


setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_11days_MeanSE.pdf", width=11, height=6)
print(Age11_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age11_Survival_Boxplot <-ggplot(data=age_11, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 11 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_11days.pdf", width=11, height=6)
print(Age11_Survival_Boxplot)
dev.off()

```


### Age 15 days ALL DATA  ------------

```{r, SURVIVAL Age 15 days - all data}
age_15<- Survival_dat%>%
  filter(Day=="15") %>% 
  arrange(Survival) 



# Age 15 Length mod - all data -------------------------------------------------------------------------------------- #

# run mod (lm model) 
Age15_Survival_lm_mod <- lm(sqrt(Survival)~OA*Salinity*Temp,data=age_15)
library(stats)
shapiro.test(residuals(Age15_Survival_lm_mod)) # 0.481 pass
leveneTest(residuals(Age15_Survival_lm_mod) ~ age_15$Temp*age_15$OA*age_15$Salinity) # 0.4767 pass
boxplot(residuals(Age15_Survival_lm_mod) ~ age_15$Temp*age_15$OA*age_15$Salinity) # visual of residuals grouped
qqnorm(resid(Age15_Survival_lm_mod)) # check for normality of residuals - looks okay

pander(anova(Age15_Survival_lm_mod), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)   |
# |:--------------------:|:--:|:---------:|:---------:|:-------:|:---------:|
# |        **OA**        | 1  |  0.1079   |  0.1079   |  5.869  |  0.02765  |
# |     **Salinity**     | 1  |  0.3459   |  0.3459   |  18.82  | 0.0005088 |
# |       **Temp**       | 1  |  0.08242  |  0.08242  |  4.483  |  0.05024  |
# |   **OA:Salinity**    | 1  | 0.002304  | 0.002304  | 0.1253  |  0.7279   |
# |     **OA:Temp**      | 1  | 0.0008117 | 0.0008117 | 0.04415 |  0.8362   |
# |  **Salinity:Temp**   | 1  |  0.02577  |  0.02577  |  1.402  |  0.2537   |
# | **OA:Salinity:Temp** | 1  | 0.007163  | 0.007163  | 0.3896  |  0.5413   |
# |    **Residuals**     | 16 |  0.2941   |  0.01838  |   NA    |    NA     |

# post hoc tests --------------------------------------------------------------------------------------------------- #

posthoc<-emmeans(Age15_Survival_lm_mod, pairwise~Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)

 # Salinity emmean     SE df lower.CL upper.CL .group
 # Low       0.134 0.0391 16   0.0507    0.217  a    
 # High      0.374 0.0391 16   0.2908    0.457   b 
((0.374-0.134)/0.374)*100

posthoc<-emmeans(Age15_Survival_lm_mod, pairwise~OA, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   emmean     SE df lower.CL upper.CL .group
 # High  0.187 0.0391 16    0.104    0.270  a    
 # Low   0.321 0.0391 16    0.238    0.404   b   
((0.321-0.187)/0.321)*100

# plot the data  ----------------------------------------------------------------------------------------------------- #
Age15_Survival_Boxplot_2 <- age_15 %>% 
  dplyr::group_by(OA,Salinity, Temp) %>% 
  dplyr::summarise(mean_surv = mean(Survival), 
                   n         = n(),
                   sd_surv   = sd(Survival),
                   se_surv   = sd_surv/(sqrt(n))) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=mean_surv, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype = Temp)) +
                              geom_point(aes (fill = fct_relevel(Salinity, c("Low", "High")), shape = Temp), position = "dodge2") +
                              geom_errorbar(aes(ymin = mean_surv - se_surv, ymax = mean_surv + se_surv), width = 0.5, position= "dodge2") +
                              theme_classic() +  
                              #ylim(0,0.75) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 15 days", x ="pCO2 level", y = "Survival")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_15days_MeanSE.pdf", width=15, height=6)
print(Age15_Survival_Boxplot_2)
dev.off()




##Here Low Salinity treatments are in Blue
Age15_Survival_Boxplot <-ggplot(data=age_15, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 15 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Survival/Survival_age_15days.pdf", width=15, height=6)
print(Age15_Survival_Boxplot)
dev.off()

```


### Age 18 days ALL DATA  ------------

```{r, SURVIVAL Age 15 days - all data}
age_18<- Survival_dat%>%
  filter(Day=="18") %>% 
  arrange(Survival)

age_18 %>% dplyr::filter(Temp %in% 'Low' & Salinity %in% 'Low'& OA %in% 'High')
age_18 %>% dplyr::filter(Temp %in% 'High' & Salinity %in% 'Low' & OA %in% 'High')


mean((age_18 %>% dplyr::filter(Temp %in% 'Low'))$Survival*100)
sd((age_18 %>% dplyr::filter(Temp %in% 'Low'))$Survival*100)

# run mod (lm model) 
Age18_Survival_lm_mod <- lm((Survival)~OA*Salinity*Temp,data=age_18)
shapiro.test(residuals(Age18_Survival_lm_mod)) #  0.000557
hist(resid(Age18_Survival_lm_mod))

Age18_Survival_lm_mod_T <- lm(asin(sqrt(Survival))~OA*Salinity*Temp,data=age_18)
shapiro.test(residuals(Age18_Survival_lm_mod_T)) #  0.07886
leveneTest(residuals(Age18_Survival_lm_mod_T) ~ age_18$Temp*age_18$OA*age_18$Salinity) # 0.2879 pass
boxplot(residuals(Age18_Survival_lm_mod_T) ~ age_18$Temp*age_18$OA*age_18$Salinity) # visual of residuals grouped
qqnorm(resid(Age18_Survival_lm_mod_T)) # check for normality of residuals - looks okay

pander(anova(Age18_Survival_lm_mod_T), style='rmarkdown') # anova table of lm
# |        &nbsp;        | Df |  Sum Sq  | Mean Sq  | F value | Pr(>F)  |
# |:--------------------:|:--:|:--------:|:--------:|:-------:|:-------:|
# |        **OA**        | 1  | 0.08944  | 0.08944  |  7.214  | 0.01624 |
# |     **Salinity**     | 1  | 0.05461  | 0.05461  |  4.404  | 0.05207 |
# |       **Temp**       | 1  | 0.04462  | 0.04462  |  3.599  | 0.07602 |
# |   **OA:Salinity**    | 1  | 0.007922 | 0.007922 | 0.6389  | 0.4358  |
# |     **OA:Temp**      | 1  | 0.005999 | 0.005999 | 0.4838  | 0.4967  |
# |  **Salinity:Temp**   | 1  | 0.01172  | 0.01172  | 0.9457  | 0.3453  |
# | **OA:Salinity:Temp** | 1  | 0.07153  | 0.07153  |  5.77   | 0.0288  |
# |    **Residuals**     | 16 |  0.1984  |  0.0124  |   NA    |   NA    |

posthoc<-emmeans(Age18_Survival_lm_mod_T, pairwise~OA*Temp*Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)

 # OA   Temp Salinity emmean     SE df lower.CL upper.CL .group
 # High Low  Low      0.0130 0.0643 16  -0.1233    0.149  a    
 # High High Low      0.0659 0.0643 16  -0.0704    0.202  ab   
 # High Low  High     0.0797 0.0643 16  -0.0565    0.216  abc  
 # Low  Low  Low      0.0938 0.0643 16  -0.0424    0.230  abc  
 # Low  High High     0.2075 0.0643 16   0.0712    0.344   bcd 
 # High High High     0.2626 0.0643 16   0.1263    0.399    cd 
 # Low  High Low      0.3019 0.0643 16   0.1656    0.438     d 
 # Low  Low  High     0.3063 0.0643 16   0.1700    0.443     d
 # 
 
 
##Here Low Salinity treatments are in Blue
Age18_Survival_Boxplot <-ggplot(data=age_18, aes(x=fct_relevel(OA, c("Low", "High")), 
                                        y=Survival, 
                                        colour=fct_relevel(Salinity, c("Low", "High")), 
                                        linetype = Temp)) +
                                          geom_boxplot() + 
                                          theme_classic() +  
                                          geom_jitter(position = position_dodge2(width = 0.75))+
                                          ylim(0,0.75) +
                                          stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                                          labs(title="Age = 18 days (all data)", 
                                               x ="pCO2 level", 
                                               y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%indiv^{-1}%.% hr^{-1}~")")) + 
                                          theme(axis.title.y = element_text(size = rel(1.3), angle =90), 
                                                axis.title.x = element_text(size = rel(1.3), angle = 0)) +
                                          theme(axis.text=element_text(size=12)) 

Age18_Survival_Boxplot
```
