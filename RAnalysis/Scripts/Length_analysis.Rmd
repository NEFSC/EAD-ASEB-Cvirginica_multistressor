---
title: "Length_analysis.Rmd"
author: "Sam Gurr"
date: "11/2/2022"
output:
  pdf_document: default
  html_document: default
---




# load libraries

```{r,setup}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(multcompView)
# library(agricolae)
library(dplyr)
library(lme4)
library(ggplot2)
library(nlme)
library(car)
library(performance)
# library(stargazer)
library(emmeans)
library(pander)
# library(survminer)
library(survival)
# library(adjustedCurves)
# library(riskRegression)
# library(pammtools)
# library(bestNormalize)
library(MASS)
```


# Set Path & load data

```{r, load}

#setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")

# EXPERIMENT METADATA 
Exp_data <-  read.csv("Data/Survival/Survival_master.csv", header = T) %>% 
                filter(Day %in% 1) %>% 
                dplyr::select(c('Temp','OA','Salinity','Replicate','Id.', 'pH', 'AR')) %>% 
                dplyr::rename(Sample.ID = Id., Aragonite_saturation = AR)


#  LENGTH DATA 
# day 1 - length data
raw_length_dat_Age1    <- read.csv("Data/Length/workbook/timepoint_1_Day1.csv", header = T,nrows=50) %>% 
                                    dplyr::mutate(Age = 1) %>% 
                                    dplyr::mutate(stage = 1)
# day 1 - length data
raw_length_dat_Age4    <- read.csv("Data/Length/workbook/timepoint_2_Day4.csv", header = T) %>% 
                                    dplyr::mutate(Age = 4) %>% 
                                    dplyr::mutate(stage = 1)
# day 8 - length data
raw_length_dat_Age8_1  <- read.csv("Data/Length/workbook/timepoint_3_Day8.csv", header = T) %>% 
                                    dplyr::mutate(Age = 8) %>% 
                                    dplyr::mutate(stage = 1)
raw_length_dat_Age8_2  <- read.csv("Data/Length/workbook/timepoint_3_Day8_additional_lengths.csv", header = T) %>% 
                                    dplyr::mutate(Age = 8) %>% 
                                    dplyr::mutate(stage = 1)
rbind(raw_length_dat_Age8_1,raw_length_dat_Age8_2)

# day 11 - length data
raw_length_dat_Age11   <- read.csv("Data/Length/workbook/timepoint_4_Day11.csv", header = T) %>% 
                                    dplyr::mutate(Age = 11) %>% 
                                    dplyr::mutate(stage = 1)

# day 15 - length data
raw_length_dat_Age15   <- read.csv("Data/Length/workbook/timepoint_5_Day15.csv", header = T) %>% 
                                    dplyr::select(-X) %>% 
                                    dplyr::mutate(Age = 15) %>% 
                                    dplyr::mutate(stage = 1)

raw_length_dat_Age19   <- read.csv("Data/Length/workbook/timepoint_6_Day19.csv", header = T) %>% 
                                    dplyr::mutate(Age = 19) %>% 
                                    dplyr::mutate(stage = 1)

raw_length_dat_Age22_larvae   <- read.csv("Data/Length/workbook/timepoint_7_Day22_larvae.csv", header = T) %>% 
                                    dplyr::mutate(Age = 22) %>% 
                                    dplyr::mutate(stage = 1)

raw_length_dat_Age22_spat   <- read.csv("Data/Length/workbook/timepoint_7_Day22_spat.csv", header = T) %>% 
                                    dplyr::mutate(Age = 22) %>% 
                                    dplyr::mutate(stage = 2)


```


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# prep data 

```{r, prep the raw data for stats} 
# master raw length file

Masterlengthdata    <- as.data.frame(rbind(sapply(raw_length_dat_Age1, as.numeric),
                                sapply(raw_length_dat_Age4, as.numeric),
                                sapply(raw_length_dat_Age8_1, as.numeric), 
                                sapply(raw_length_dat_Age8_2, as.numeric),
                                sapply(raw_length_dat_Age11, as.numeric),
                                sapply(raw_length_dat_Age15, as.numeric),
                                sapply(raw_length_dat_Age19, as.numeric),
                                sapply(raw_length_dat_Age22_larvae, as.numeric),
                                sapply(raw_length_dat_Age22_spat, as.numeric))) %>% 
                            dplyr::mutate(stage = case_when(stage == 1 ~ 'larvae',
                                                            stage == 2 ~ 'spat'))
                        

# Age 1
raw_length_Age1MELT <-  reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 1))) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age1_raw_length      <- merge(raw_length_Age1MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                        dplyr::mutate(Age = 1)


# Age 4
raw_length_Age4MELT <-  reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 4))) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age4_raw_length      <- merge(raw_length_Age4MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                        dplyr::mutate(Age = 4)


# Age 8
raw_length_Age8MELT <-  reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 8))) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age8_raw_length      <- merge(raw_length_Age8MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                        dplyr::mutate(Age = 8)

# Age 11
raw_length_Age11MELT <-  reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 11))) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age11_raw_length      <- merge(raw_length_Age11MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                        dplyr::mutate(Age = 11)

# Age 15
raw_length_Age15MELT <- reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 15))) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age15_raw_length      <- merge(raw_length_Age15MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                        dplyr::mutate(Age = 15)


# Age 19
raw_length_Age19MELT <- reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 19))) %>% 
                        na.omit %>% 
                        dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                        dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age19_raw_length      <- merge(raw_length_Age19MELT, Exp_data, by = 'Sample.ID')  %>% 
                        dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                        dplyr::mutate(Age = 19)


# Age 22
raw_length_Age22MELT_larvae  <- reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 22 & stage == 'larvae'))) %>% 
                                  na.omit %>% 
                                  dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                                  dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age22_raw_length_larvae      <- merge(raw_length_Age22MELT_larvae, Exp_data, by = 'Sample.ID')  %>% 
                                  dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                                  dplyr::mutate(Age = 22)


raw_length_Age22MELT_spat  <- reshape2::melt((as.data.frame(Masterlengthdata) %>% dplyr::filter(Age == 22 & stage == 'spat'))) %>% 
                                  na.omit %>% 
                                  dplyr::rename(length_um = value , Sample.ID =variable) %>% 
                                  dplyr::mutate(Sample.ID = gsub('.*Sample.','', Sample.ID))

Age22_raw_length_spat      <- merge(raw_length_Age22MELT_spat, Exp_data, by = 'Sample.ID')  %>% 
                                  dplyr::mutate(random_fact = paste( substr(Temp,1,1), substr(OA,1,1), substr(Salinity,1,1), '_', Replicate, sep = '')) %>%
                                  dplyr::mutate(Age = 22)

Master_Lengths <- rbind(Age1_raw_length,
                        Age4_raw_length,
                        Age8_raw_length,
                        Age11_raw_length,
                        Age15_raw_length,
                        Age19_raw_length,
                        Age22_raw_length_larvae,
                        Age22_raw_length_spat)
#View(Master_Lengths)
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
write.csv(Master_Lengths, 
          "Data/Length/cumulative_raw/Length_cumulative_raw.csv")# write


Master_Lengths_summ <- summarySE(Master_Lengths, 
                              measurevar="length_um", 
                              groupvars=c("Age", "Temp", "OA", "Salinity", "Aragonite_saturation")) %>%
                        dplyr::arrange(Aragonite_saturation) %>% 
                        dplyr::arrange(Age) %>% 
                        dplyr::mutate(mean_SE = paste0(
                          signif(length_um, digits=3),
                          " ± ",
                          signif(se, digits=3)))


# output csv of mean csv
setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
write.csv(Master_Lengths_summ, 
          "Data/Length/cumulative_raw/Length_MeanSE.csv")# write

# Temp OA Salinity Aragonite_saturation N length_um sd se ci
# High	Low	High	 1.6	763	319.12327	437.40866	15.8352566	31.085908
# Low	Low	High	   1.5	542	98.05435	23.21156	0.9970219	1.958508
# High	High	High 0.7	875	299.98840	393.88775	13.3158363	26.134752
# High	Low	Low	   0.6	619	181.07192	236.28354	9.4970372	18.650377
# Low	High	High	 0.6	547	92.71646	18.64946	0.7973934	1.566334
# Low	Low	Low	     0.5	483	94.08717	23.32495	1.0613220	2.085389
# High	High	Low	 0.3	337	79.91682	21.42763	1.1672374	2.296014
# Low	High	Low	   0.2	398	80.21241	14.42678	0.7231490	1.421680


```
 
 
 
 
 
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot all data
 
* note that all treatments are represented in this figure
```{r,plot day 1 - 15 heat facet}

Length_means <- Master_Lengths %>% 
                          dplyr::filter(stage %in% 'larvae') %>% 
                          na.omit() %>% 
                          dplyr::group_by(Age, OA, Salinity, Temp) %>% 
                          dplyr::summarise(mean_length = mean(length_um), 
                                           n           = n(),
                                           sd_length   = sd(length_um),
                                           se_length   = sd_length/(sqrt(n))) 


GR_means <- as.data.frame(Length_means %>% 
  filter(Age %in% c(1,15)) %>% 
  dplyr::select(c(Age, OA, Salinity, Temp, mean_length)) %>% 
  dplyr::group_by(OA, Salinity, Temp)  %>% 
  tidyr::spread(Age, mean_length) %>%  # new columns titled 1 and 15 for he Age and with values for the 
  # length data grouped by treatment 
  dplyr::mutate(Growth_rate_umday = (`15` - `1`) / 14) %>% 
  dplyr::select(!c(`1`,`15`))) # note 1 missing value for OA High Temp Low Salinity Low

getNA <- as.data.frame(Length_means %>% 
  filter(Age %in% c(1,11)) %>% 
  dplyr::select(c(Age, OA, Salinity, Temp, mean_length)) %>% 
  dplyr::group_by(OA, Salinity, Temp)  %>% 
  tidyr::spread(Age, mean_length) %>%  # new columns titled 1 and 15 for he Age and with values for the 
  # length data grouped by treatment 
  dplyr::mutate(Growth_rate_umday = (`11` - `1`) / 13) %>% 
  dplyr::select(!c(`1`,`11`))) # 2.612424 for OA High Temp Low Salinity Low, insert into the other table

GR_means[4,4] = 2.612424

GR_means$Growth_rate_umday <- as.numeric(GR_means$Growth_rate_umday)

Length_means_MASTER <- merge(Length_means, GR_means, by=c('OA', 'Salinity', 'Temp'))

# plot - length



Length_means_MASTER_larvae <- Length_means_MASTER %>%  dplyr::filter(!Age %in% c(19,22))


Heatplot_larvae <- Length_means_MASTER_larvae %>% 
                      dplyr::mutate(OA_Sal = 
                                      paste(substr(OA,1,1),
                                      substr(Salinity,1,1),
                                      sep = '')) %>% 
                       ggplot(aes(x = Age,
                                  y = mean_length)) + 
                       geom_rect(aes(fill = Growth_rate_umday), 
                                   xmin = -Inf, 
                                   xmax = Inf, 
                                   ymin = -Inf, 
                                   ymax = Inf, 
                                   alpha = 0.3) +
                      geom_point(color = 'black') +
                      geom_line(aes(x = Age,
                                    y = mean_length)) +
                       geom_errorbar(aes(ymin = mean_length - se_length, 
                                         ymax = mean_length + se_length), 
                                        width = 0.5, 
                                        position= "dodge2") +
                      geom_smooth(method = "lm", 
                                  se = FALSE, 
                                  size = 1, 
                                  color = 'white') +
                      theme_bw() +  
                      theme(panel.grid.major = element_blank(),
                            panel.grid.minor = element_blank()) +
                      facet_grid(vars(Temp), 
                                 vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH")))) +
                      geom_text(size = 2, 
                                   aes(x = 12, 
                                       y = 0.8, 
                                       label = paste0(round(Growth_rate_umday,2),"um day-1"))) +
                      scale_fill_gradient(low = "orange", 
                                           high = "forestgreen", 
                                           aesthetics = "fill")

       
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/plots/Length_day1_day15.pdf", width=11, height=5)
print(Heatplot_larvae)
dev.off()


```



#### plot data from day 1 corresponding with the TagSeq data 

* TagSeq samples taken on day 1 and day 22

  - day 1 has all replicates/treatmets represented  (8 tretmentd for TagSeq)
  
  - day 22 has spat and larvae parsed, note that only three treatments are represented (of 4 in TagSeq, low temp excluded) 
  
  - alternative to day 22 - explored the sizes at late larval stages
  
* day 1 

* growth rate heatplot for post day 15 and the four treatments that we have for TagSeq

* day 19 and 22

```{r, plots overlaid for TagSeq data}

######################################################## #
# day 1
unique(Master_Lengths$Age) # 1  4  8 11 15 19 22
Length_means_day1 <- Master_Lengths %>% 
                          dplyr::filter(Age %in% 1) %>% 
                          na.omit() %>% 
                          dplyr::group_by(Age, OA, Salinity, Temp, stage) %>% 
                          dplyr::summarise(mean_length = mean(length_um), 
                                           n           = n(),
                                           sd_length   = sd(length_um),
                                           se_length   = sd_length/(sqrt(n)))

Heatplot_day1 <- Length_means_day1 %>% 
                          dplyr::mutate(OA_Sal = 
                                          paste(substr(OA,1,1),
                                          substr(Salinity,1,1),
                                          sep = '')) %>% 
                           ggplot(aes(x = as.factor(Age),
                                      y = mean_length,
                                      shape = stage)) + 
                          geom_point(color = 'black', size = 3) +
                           geom_errorbar(aes(ymin = mean_length - se_length, 
                                             ymax = mean_length + se_length), 
                                            width = 0.5) +
                          theme_bw() +  
                          theme(panel.grid.major = element_blank(),
                                panel.grid.minor = element_blank()) +
                          facet_grid(vars(Temp), 
                                     vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH"))))

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/plots/Length_day1.pdf", width=11, height=5)
print(Heatplot_day1)
dev.off()

######################################################## #
# day 15
unique(Master_Lengths$Age) # 1  4  8 11 15 19 22
Length_means_day15 <- Master_Lengths %>% 
                          dplyr::filter(Age %in% 15) %>% 
                          na.omit() %>% 
                          dplyr::group_by(Age, OA, Salinity, Temp, stage) %>% 
                          dplyr::summarise(mean_length = mean(length_um), 
                                           n           = n(),
                                           sd_length   = sd(length_um),
                                           se_length   = sd_length/(sqrt(n)))

Heatplot_day15 <- Length_means_day15 %>% 
                          dplyr::mutate(OA_Sal = 
                                          paste(substr(OA,1,1),
                                          substr(Salinity,1,1),
                                          sep = '')) %>% 
                           ggplot(aes(x = as.factor(Age),
                                      y = mean_length,
                                      shape = stage)) + 
                          geom_point(color = 'black', size = 3) +
                           geom_errorbar(aes(ymin = mean_length - se_length, 
                                             ymax = mean_length + se_length), 
                                            width = 0.5) +
                          theme_bw() +  
                          theme(panel.grid.major = element_blank(),
                                panel.grid.minor = element_blank()) +
                          facet_grid(vars(Temp), 
                                     vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH"))))

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/plots/Length_day15.pdf", width=11, height=5)
print(Heatplot_day15)
dev.off()


######################################################## #
# days 15 - 22
unique(Master_Lengths$Age) # 1  4  8 11 15 19 22
Length_means_day15to22 <- Master_Lengths %>% 
                          dplyr::filter(Age %in% c(15,19,22)) %>% 
                          na.omit() %>% 
                          dplyr::group_by(Age, OA, Salinity, Temp, stage) %>% 
                          dplyr::summarise(mean_length = mean(length_um), 
                                           n           = n(),
                                           sd_length   = sd(length_um),
                                           se_length   = sd_length/(sqrt(n)))

######################################################## #
# day 19 and 22 - spat and larvae parsed
Length_means_day19_22 <- Master_Lengths %>% 
                          dplyr::filter(Age %in% c(19,22)) %>% 
                          na.omit() %>% 
                          dplyr::group_by(Age, OA, Salinity, Temp, stage) %>% 
                          dplyr::summarise(mean_length = mean(length_um), 
                                           n           = n(),
                                           sd_length   = sd(length_um),
                                           se_length   = sd_length/(sqrt(n)))

Heatplot_larvaespat <- Length_means_day19_22 %>% 
                          dplyr::mutate(OA_Sal = 
                                          paste(substr(OA,1,1),
                                          substr(Salinity,1,1),
                                          sep = '')) %>% 
                           ggplot(aes(x = as.factor(Age),
                                      y = mean_length,
                                      shape = stage)) + 
                          geom_point(color = 'black', size = 3) +
                           geom_errorbar(aes(ymin = mean_length - se_length, 
                                             ymax = mean_length + se_length), 
                                            width = 0.5) +
                          theme_bw() +  
                          theme(panel.grid.major = element_blank(),
                                panel.grid.minor = element_blank()) +
                          facet_grid(vars(Temp), 
                                     vars(fct_relevel(OA_Sal, c("HL", "LL", "HH", "LH"))))

Heatplot_larvaespat

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/plots/Length_day19_day22.pdf", width=11, height=5)
print(Heatplot_larvaespat)
dev.off()


```





```{r}
Length_all_MeanSE_plot <- Length_means %>% 
                                ggplot(aes(x = Age,
                                           y=mean_length, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_point(aes(fill = fct_relevel(Salinity, c("Low", "High")), 
                                           shape = fct_relevel(OA, c("Low", "High"))),
                                           position = "dodge2") +
                                geom_line(aes(x = Age,
                                           y=mean_length, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_errorbar(aes(ymin = mean_length - se_length, 
                                                  ymax = mean_length + se_length), 
                                              width = 0.5, position= "dodge2") +
                                theme_classic() +  
                                facet_wrap(~(fct_relevel(OA, c("Low", "High"))))
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_all_MeanSE.pdf", width=11, height=6)
print(Length_all_MeanSE_plot)
dev.off()


# length data for scallops days 1 and 4 
Length_Day1.4_MeanSE_plot <- Length_means %>% 
                                dplyr::filter(Age %in% c(1, 4)) %>% 
                                ggplot(aes(x = Age,
                                           y=mean_length, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_point(aes(fill = fct_relevel(Salinity, c("Low", "High")), 
                                           shape = fct_relevel(OA, c("Low", "High"))),
                                           position = "dodge2") +
                                geom_line(aes(x = Age,
                                           y=mean_length, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_errorbar(aes(ymin = mean_length - se_length, 
                                                  ymax = mean_length + se_length), 
                                              width = 0.5, position= "dodge2") +
                                theme_classic() +  
                                facet_wrap(~(fct_relevel(OA, c("Low", "High"))))
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_Day1.4_MeanSE.pdf", width=11, height=6)
print(Length_Day1.4_MeanSE_plot)
dev.off()



# length data for scallops days after day 4
Length_Days8.11.15_MeanSE_plot <- Length_means %>% 
                                dplyr::filter(Age > 4) %>% 
                                ggplot(aes(x = Age,
                                           y=mean_length, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_point(aes(fill = fct_relevel(Salinity, c("Low", "High")), 
                                           shape = fct_relevel(OA, c("Low", "High"))),
                                           position = "dodge2") +
                                geom_line(aes(x = Age,
                                           y=mean_length, 
                                           colour=fct_relevel(Salinity, c("Low", "High")), 
                                           linetype = Temp)) +
                                geom_errorbar(aes(ymin = mean_length - se_length, 
                                                  ymax = mean_length + se_length), 
                                              width = 0.5, position= "dodge2") +
                                theme_classic() +  
                                facet_wrap(~(fct_relevel(OA, c("Low", "High"))))
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_Days8.11.15_MeanSE.pdf", width=11, height=6)
print(Length_Days8.11.15_MeanSE_plot)
dev.off()





# statistical approach test
Length_lme_mod<- lmer(length_um~OA*Temp*Salinity + (1+Age|random_fact),data=Master_Lengths)
pander(anova(Length_lme_mod), style='rmarkdown')
pvals.fnc(Length_lme_mod, nsims = n, withMCMC = TRUE)


ShellLength_Boxplot <- ggplot(data=Master_Lengths, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_classic() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Larvae size (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                    axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0))+
                              theme(axis.text=element_text(size=12)) +
                              facet_wrap(~Age)
ShellLength_Boxplot



ShellLength_Boxplot_Day1 <- Master_Lengths %>%  dplyr::filter(Age == 1) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_classic() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Larvae size (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                    axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0))+
                              theme(axis.text=element_text(size=12))
ShellLength_Boxplot_Day1


ShellLength_Boxplot_Days4.8 <- Master_Lengths %>%  dplyr::filter(Age %in% c(4, 8)) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_classic() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 4 and 8 days", x ="pCO2 level", y = "Larvae size (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                    axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0))+
                              theme(axis.text=element_text(size=12)) +
                              facet_wrap(~Age)
ShellLength_Boxplot_Days4.8


ShellLength_Boxplot_Days11.15 <-  Master_Lengths %>%  dplyr::filter(Age %in% c(11, 15)) %>% 
                              ggplot(aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_classic() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 11 and 15 days", x ="pCO2 level", y = "Larvae size (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), 
                                                                angle =90), 
                                    axis.title.x = element_text(size = rel(1.3), 
                                                                angle = 0))+
                              theme(axis.text=element_text(size=12)) +
                              facet_wrap(~OA*Age)
ShellLength_Boxplot_Days11.15
```






:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# STATISTICAL ANALYSIS

### Age 24 hours ALL DATA ------------

```{r, LENGTH Age 24 hours size - all data}

# Age 1 Length mod - all data -------------------------------------------------------------------------------------- #


Age1Length_lme_mod <- lme(length_um~OA*Temp*Salinity,random=~1|random_fact,data=Age1_raw_length)
pander(anova(Age1Length_lme_mod), style='rmarkdown') # anova table of lmer
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   | 1176  | 151157  |     0     |
# |        **OA**        |   1   |  16   |  108.4  | 1.56e-08  | *
# |       **Temp**       |   1   |  16   |  18.6   | 0.0005359 | *
# |     **Salinity**     |   1   |  16   |  120.4  | 7.426e-09 | *
# |     **OA:Temp**      |   1   |  16   |  1.363  |  0.2601   |
# |   **OA:Salinity**    |   1   |  16   |  5.876  |  0.02756  | *
# |  **Temp:Salinity**   |   1   |  16   |  2.105  |  0.1661   |
# | **OA:Temp:Salinity** |   1   |  16   |  1.135  |  0.3026   |
leveneTest(residuals(Age1Length_lme_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # 0.2716 PASS
boxplot(residuals(Age1Length_lme_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age1Length_lme_mod)) # check for normality of residuals       


# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age1Length_lme_mod, pairwise~OA:Salinity, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Salinity emmean    SE df lower.CL upper.CL .group
 # High Low        67.7 0.371 16     66.9     68.5  a    
 # Low  Low        72.5 0.371 16     71.7     73.3   b   
 # High High       72.7 0.371 16     71.9     73.5   b   
 # Low  High       75.6 0.371 16     74.9     76.4    c 

# OUTPUT
library(tibble)
# raw table (levenes was good)
write.table(tibble::rownames_to_column(as.data.frame(anova(Age1Length_lme_mod)), "Treatment"),
            "C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day1_LME_raw.csv",sep=",", row.names=FALSE)  
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day1_LME_raw_QQnorm.pdf"), width=10, height=12) 
print(qqnorm(resid(Age1Length_lme_mod)))
dev.off()
write.table(as.data.frame(multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)),
            "C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day1_LME_raw_posthoc.csv",sep=",", row.names=FALSE)  # write table to 






# 
# glmer_day1 <- glm(length_um~OA*Temp*Salinity,data=Age1_raw_length,family=gaussian())
# summary(glmer_day1)
# shapiro.test(resid(glmer_day1))
# 
# 
# 
# ?glm
# library(lme4)
# glmer_day1 <- glmer(length_um~OA*Temp*Salinity + (1|random_fact) , data = Age1_raw_length, family = gaussian) 
# summary(glmer_day1)
# anova(glmer_day1)


# run model (lm mod) - NO RANDOM EFFECT OF TANK
Age1Length_lm_mod <- lm(length_um~OA*Temp*Salinity,data=Age1_raw_length)
pander(anova(Age1Length_lm_mod), style='rmarkdown') # anova table of lmer
shapiro.test(residuals(Age1Length_lm_mod)) # 0.002907 no pass
leveneTest(residuals(Age1Length_lm_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # 0.2793 PASS
boxplot(residuals(Age1Length_lm_mod) ~ Age1_raw_length$Temp*Age1_raw_length$OA*Age1_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age1Length_lm_mod)) # check for normality of residuals       
ggplot(Age1_raw_length, aes(x = length_um)) + geom_histogram(binwidth = 1, fill = "white", colour = "black") # histogram
# boxcox transformation
b      <- boxcox(Age1Length_lm_mod)
lambda <- b$x[which.max(b$y)]    
Age1_raw_length$length_um_boxcox <- (Age1_raw_length$length_um ^ lambda - 1) / lambda
Age1Length_lm_mod_boxcox <- lm(length_um_boxcox~OA*Salinity*Temp,data=Age1_raw_length)
pander(anova(Age1Length_lm_mod_boxcox), style='rmarkdown') # anova table of lmr
shapiro.test(residuals(Age1Length_lm_mod_boxcox)) 
leveneTest(Age1Length_lm_mod_boxcox) 





# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age1Length_lm_mod, pairwise~OA:Salinity:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Salinity Temp emmean    SE   df lower.CL upper.CL .group 
 # High Low      Low    66.8 0.267 1192     66.2     67.3  a      
 # High Low      High   68.7 0.267 1192     68.1     69.2   b     
 # High High     Low    71.6 0.267 1192     71.1     72.1    c    
 # Low  Low      Low    72.4 0.267 1192     71.8     72.9     d   
 # Low  Low      High   72.6 0.267 1192     72.1     73.1     d   
 # High High     High   73.8 0.267 1192     73.2     74.3      e  
 # Low  High     Low    74.6 0.267 1192     74.1     75.1       f 
 # Low  High     High   76.7 0.267 1192     76.2     77.2        g


# plot the data  ----------------------------------------------------------------------------------------------------- #


Age1_ShellLength_Boxplot <- ggplot(data=Age1_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_classic() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 24 hours", x ="pCO2 level", y = "Larvae size (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

# save the plot 
setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_age_24hrs_Boxplots.pdf", width=8, height=6)
print(Age1_ShellLength_Boxplot)
dev.off()




# -------------------------------------------------------------------------------------------------------------------- #


# For the results section -  expand upon the mean sd and percent differences in the Tukey HSD 
Age1_Length_Table <- Age1_raw_length %>% 
                        dplyr::group_by(OA,Salinity) %>% 
                        dplyr::summarise(mean_length = mean(length_um),
                                         n = n(),
                                         sd_length = sd(length_um),
                                         se_length = sd_length/(sqrt(n)))

# how many animals were measured per replicate / per treatment?
Age1_raw_length %>% 
            dplyr::group_by(random_fact) %>% 
            dplyr::summarise(n = n())
```


### Age 4 days ALL DATA  ------------

```{r, LENGTH Age 4 days hours size - all data}


# Age 4 Length mod - all data -------------------------------------------------------------------------------------- #


Age4Length_lme_mod <- lme(length_um~OA*Salinity*Temp,random=~1|random_fact,data=Age4_raw_length)
pander(anova(Age4Length_lme_mod), style='rmarkdown') # anova table of lmer
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  378  |  10702  |     0     |
# |        **OA**        |   1   |  16   |  30.04  | 5.033e-05 |
# |     **Salinity**     |   1   |  16   |  13.73  | 0.001921  |
# |       **Temp**       |   1   |  16   |  1.675  |   0.214   |
# |   **OA:Salinity**    |   1   |  16   | 0.6367  |  0.4366   |
# |     **OA:Temp**      |   1   |  16   |  10.42  | 0.005262  | *
# |  **Salinity:Temp**   |   1   |  16   | 0.3258  |   0.576   |
# | **OA:Salinity:Temp** |   1   |  16   |  2.811  |  0.1131   |
leveneTest(residuals(Age4Length_lme_mod) ~ Age4_raw_length$Temp*Age4_raw_length$OA*Age4_raw_length$Salinity) # 0.2059 pass
boxplot(residuals(Age4Length_lme_mod) ~ Age4_raw_length$Temp*Age4_raw_length$OA*Age4_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age4Length_lme_mod)) # check for normality of residuals - looks okay

posthoc<-emmeans(Age4Length_lme_mod, pairwise~OA:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Temp emmean   SE df lower.CL upper.CL .group
 # High High   74.7 1.62 16     71.2     78.1  a    
 # High Low    77.7 1.58 16     74.4     81.1  a    
 # Low  Low    81.8 1.50 16     78.6     84.9   b   
 # Low  High   88.7 1.57 16     85.3     92.0    c 


# OUTPUT
library(tibble)
# raw table (levenes was good)
write.table(tibble::rownames_to_column(as.data.frame(anova(Age4Length_lme_mod)), "Treatment"),
            "C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day4_LME_raw.csv",sep=",", row.names=FALSE)  # write table to 
# qqnorm fig
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day4_LME_raw_QQnorm.pdf"), width=10, height=12) # 20211026_resp_unfed.csv ONLY
print(qqnorm(resid(Age4Length_lme_mod)))
dev.off() 
# posthoc table 
write.table(as.data.frame(multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)),
            "C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day4_LME_raw_posthoc.csv",sep=",", row.names=FALSE)  # write table to 










# THREE WAY ANOVA (NO RANDOM FACTOR) :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Age4Length_lm_mod <- lm(length_um~OA*Salinity*Temp,data=Age4_raw_length)
pander(anova(Age4Length_lm_mod), style='rmarkdown') # anova table of lmr
# |        &nbsp;        | Df  | Sum Sq | Mean Sq | F value |  Pr(>F)   |
# |:--------------------:|:---:|:------:|:-------:|:-------:|:---------:|
# |        **OA**        |  1  |  6415  |  6415   |  83.8   | 3.006e-18 |
# |     **Salinity**     |  1  |  2701  |  2701   |  35.28  | 6.28e-09  |
# |       **Temp**       |  1  |  469   |   469   |  6.126  |  0.01374  |
# |   **OA:Salinity**    |  1  | 202.2  |  202.2  |  2.641  |  0.1049   |
# |     **OA:Temp**      |  1  |  2582  |  2582   |  33.73  | 1.309e-08 |
# |  **Salinity:Temp**   |  1  | 20.36  |  20.36  | 0.2659  |  0.6064   |
# | **OA:Salinity:Temp** |  1  | 864.4  |  864.4  |  11.29  | 0.0008547 |
# |    **Residuals**     | 394 | 30163  |  76.56  |   NA    |    NA     |
shapiro.test(residuals(Age4Length_lm_mod)) # 0.1884
leveneTest(residuals(Age4Length_lm_mod) ~ Age4_raw_length$Temp*Age4_raw_length$OA*Age4_raw_length$Salinity) # 0.1496 pass
boxplot(residuals(Age4Length_lm_mod) ~ Age4_raw_length$Temp*Age4_raw_length$OA*Age4_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age4Length_lm_mod)) # check for normality of residuals - looks okay




# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age4Length_lm_mod, pairwise~OA:Salinity:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Salinity Temp emmean   SE  df lower.CL upper.CL .group
 # High Low      Low    72.5 1.30 394     69.9     75.1  a    
 # High Low      High   73.2 1.57 394     70.1     76.2  a    
 # High High     High   76.1 1.28 394     73.6     78.6  a    
 # Low  Low      Low    80.9 1.07 394     78.8     83.0   b   
 # Low  High     Low    83.2 1.11 394     81.0     85.4   bc  
 # High High     Low    83.2 1.24 394     80.8     85.7   bc  
 # Low  Low      High   85.5 1.16 394     83.2     87.8    c  
 # Low  High     High   92.1 1.33 394     89.5     94.7     d 

# plot the data  ----------------------------------------------------------------------------------------------------- #


require(forcats)
Age4_ShellLength_Boxplot <- ggplot(data=Age4_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_bw() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 4 days", x ="pCO2 level", y = "Shell Length (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_age_4days_Boxplots.pdf", width=4, height=6)
print(Age4_ShellLength_Boxplot)
dev.off()

```


### Age 8 days ALL DATA  ------------

```{r, LENGTH Age 8 days hours size - all data}

Age8_raw_length <- Age8_raw_length %>% mutate(group = substr(random_fact,1,3))
# Age 8 Length mod - all data -------------------------------------------------------------------------------------- #


Age8Length_lme_mod <- lme(length_um~OA*Salinity*Temp,random=~1|random_fact,data=Age8_raw_length)
pander(anova(Age8Length_lme_mod), style='rmarkdown') # anova table of lmer
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   | 1659  |  52761  |     0     |
# |        **OA**        |   1   |  16   |  17.24  | 0.0007493 |
# |     **Salinity**     |   1   |  16   |  17.66  | 0.000676  |
# |       **Temp**       |   1   |  16   |  3.026  |  0.1011   |
# |   **OA:Salinity**    |   1   |  16   | 0.08178 |  0.7786   |
# |     **OA:Temp**      |   1   |  16   |  4.522  |  0.04937  | **
# |  **Salinity:Temp**   |   1   |  16   |  3.228  |  0.09127  |
# | **OA:Salinity:Temp** |   1   |  16   |  1.939  |  0.1829   |
leveneTest(residuals(Age8Length_lme_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # < 2.2e-16 *** - did not pass
boxplot(residuals(Age8Length_lme_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age8Length_lme_mod)) # check for normality of residuals - looks okay
hist(resid(Age8Length_lme_mod))

# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age8Length_lme_mod, pairwise~OA:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Temp emmean   SE df lower.CL upper.CL .group
 # High High   94.2 4.45 16     84.8      104  a    
 # High Low    95.4 4.38 16     86.1      105  ab   
 # Low  Low   104.0 4.36 16     94.8      113   b   
 # Low  High  123.5 4.34 16    114.3      133    c  


# OUTPUT
library(tibble)
# raw table (levenes was good)
write.table(tibble::rownames_to_column(as.data.frame(anova(Age8Length_lme_mod)), "Treatment"),
            "C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day8_LME_raw_nopass.csv",sep=",", row.names=FALSE)
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day8_LME_raw_QQnorm.pdf"), width=10, height=12) 
print(qqnorm(resid(Age8Length_lme_mod)))
dev.off() 

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day8_LME_raw_residboxplot.pdf"), width=10, height=12) 
print(boxplot(residuals(Age8Length_lme_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity))
dev.off() 

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day8_LME_raw_hist.pdf"), width=10, height=12) 
print(hist(resid(Age8Length_lme_mod)))
dev.off() 

write.table(as.data.frame(multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)),
            "C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis/Output/Length/stat_tables/Day8_LME_raw_posthoc.csv",sep=",", row.names=FALSE)  # write table to 





# THREE WAY ANOVA (NO RANDOM FACTOR) :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
Age8Length_lm_mod <- lm(length_um~OA*Salinity*Temp,data=Age8_raw_length)
pander(anova(Age8Length_lm_mod), style='rmarkdown') # anova table of lmr
# |        &nbsp;        |  Df  | Sum Sq | Mean Sq | F value |  Pr(>F)   |
# |:--------------------:|:----:|:------:|:-------:|:-------:|:---------:|
# |        **OA**        |  1   | 87009  |  87009  |  269.5  | 3.636e-54 |
# |     **Salinity**     |  1   | 76531  |  76531  |  237.1  | 1.894e-48 |
# |       **Temp**       |  1   | 25675  |  25675  |  79.53  | 2.022e-18 |
# |   **OA:Salinity**    |  1   |  3917  |  3917   |  12.13  | 0.0005157 |
# |     **OA:Temp**      |  1   | 37837  |  37837  |  117.2  | 5.505e-26 |
# |  **Salinity:Temp**   |  1   | 27137  |  27137  |  84.06  | 2.408e-19 |
# | **OA:Salinity:Temp** |  1   | 21019  |  21019  |  65.11  | 1.898e-15 |
# |    **Residuals**     | 1065 | 343803 |  322.8  |   NA    |    NA     |
shapiro.test(residuals(Age8Length_lm_mod)) # 1.397e-14
leveneTest(residuals(Age8Length_lm_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # < 2.2e-16 *** - did not pass
boxplot(residuals(Age8Length_lm_mod) ~ Age8_raw_length$Temp*Age8_raw_length$OA*Age8_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age8Length_lm_mod)) # check for normality of residuals - looks okay


# boxcox transformation
b      <- boxcox(Age8Length_lm_mod)
lambda <- b$x[which.max(b$y)]    
Age8_raw_length$length_um_boxcox <- (Age8_raw_length$length_um ^ lambda - 1) / lambda
Age8Length_lm_mod_boxcox <- lm(length_um_boxcox~OA*Salinity*Temp,data=Age8_raw_length)
pander(anova(Age8Length_lm_mod_boxcox), style='rmarkdown') # anova table of lmr
shapiro.test(residuals(Age8Length_lm_mod_boxcox)) # 0.0001068
leveneTest(Age8Length_lm_mod_boxcox) # 1.958e-14 ***

# median absolute deviation to resolve outliers
med <- median(Age8_raw_length$length_um)
median(abs(Age8_raw_length$length_um-med)) # 15.14469
mad(Age8_raw_length$length_um) # 22.45352
hey <- as.data.frame(Age8_raw_length$length_um[which((abs(Age8_raw_length$length_um - median(Age8_raw_length$length_um)) / mad(Age8_raw_length$length_um)) > 2)])






# quantNorm = function(x){qnorm(rank(x,ties.method = "average")/(length(x)+1))}
# 
# Age8Length_lm_mod <- lm(quantNorm(Age8_raw_length$length_um)~OA*Salinity*Temp,data=Age8_raw_length)
# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age8Length_lm_mod, pairwise~OA:Salinity:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Salinity Temp emmean   SE   df lower.CL upper.CL .group
 # High Low      High   87.4 1.83 1065     83.8     91.0  a    
 # High Low      Low    90.7 1.75 1065     87.3     94.1  a    
 # High High     High  101.1 1.47 1065     98.3    104.0   b   
 # Low  Low      Low   103.5 1.61 1065    100.3    106.6   bc  
 # High High     Low   103.5 1.47 1065    100.6    106.4   bc  
 # Low  Low      High  105.2 1.49 1065    102.2    108.1   bc  
 # Low  High     Low   105.5 1.47 1065    102.6    108.3    c  
 # Low  High     High  144.0 1.47 1065    141.1    146.8     d 

# plot the data  ----------------------------------------------------------------------------------------------------- #


require(forcats)
Age8_ShellLength_Boxplot <- ggplot(data=Age8_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_bw() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 8 days", x ="pCO2 level", y = "Shell Length (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90),
                                    axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_age_8days_Boxplots.pdf", width=8, height=6)
print(Age8_ShellLength_Boxplot)
dev.off()

```



### Age 11 days ALL DATA  ------------

```{r, LENGTH Age 11 days hours size - all data}


# Age 11 Length mod - all data -------------------------------------------------------------------------------------- #


Age11Length_lme_mod <- lme(length_um~OA*Salinity*Temp,random=~1|random_fact,data=Age11_raw_length)
pander(anova(Age11Length_lme_mod), style='rmarkdown') # anova table of lmer
# |        &nbsp;        | numDF | denDF | F-value |  p-value  |
# |:--------------------:|:-----:|:-----:|:-------:|:---------:|
# |   **(Intercept)**    |   1   |  426  |  766.3  |     0     |
# |        **OA**        |   1   |  13   |  4.216  |  0.06075  |
# |     **Salinity**     |   1   |  13   |  10.09  | 0.007292  |
# |       **Temp**       |   1   |  13   |  21.93  | 0.0004286 |
# |   **OA:Salinity**    |   1   |  13   | 0.3512  |  0.5636   |
# |     **OA:Temp**      |   1   |  13   | 0.9637  |  0.3442   |
# |  **Salinity:Temp**   |   1   |  13   |  12.37  | 0.003786  | **
# | **OA:Salinity:Temp** |   1   |  13   |  0.563  |  0.4664   |
leveneTest(residuals(Age11Length_lme_mod) ~ Age11_raw_length$Temp*Age11_raw_length$OA*Age11_raw_length$Salinity) # < 2.2e-16 ***
boxplot(residuals(Age11Length_lme_mod) ~ Age11_raw_length$Temp*Age11_raw_length$OA*Age11_raw_length$Salinity) # visual of residuals grouped
hist(resid(Age11Length_lme_mod)) # check for normality of residuals - looks okay
qqnorm(resid(Age11Length_lme_mod)) # check for normality of residuals - looks okay


# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age11Length_lme_mod, pairwise~Salinity:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # Salinity Temp emmean    SE df lower.CL upper.CL .group
 # High     Low     104  8.50 13     86.1      123  a    
 # Low      Low     107 12.01 13     81.5      133  a    
 # Low      High    110 12.40 13     83.3      137  a    
 # High     High    172  8.31 13    153.9      190   b  


#  run model (lm)
Age11Length_lm_mod <- lm(log(length_um)~OA*Salinity*Temp,data=Age11_raw_length)
pander(anova(Age11Length_lm_mod), style='rmarkdown') # anova table of lmr
# |        &nbsp;        | Df  | Sum Sq  | Mean Sq | F value |  Pr(>F)   |
# |:--------------------:|:---:|:-------:|:-------:|:-------:|:---------:|
# |        **OA**        |  1  |  3.719  |  3.719  |  82.5   | 3.618e-18 |
# |     **Salinity**     |  1  |  4.506  |  4.506  |  99.94  | 2.451e-21 |
# |       **Temp**       |  1  |  11.2   |  11.2   |  248.4  | 1.128e-44 |
# |   **OA:Salinity**    |  1  | 0.9068  | 0.9068  |  20.11  | 9.325e-06 |
# |     **OA:Temp**      |  1  | 0.05226 | 0.05226 |  1.159  |  0.2822   |
# |  **Salinity:Temp**   |  1  |  3.778  |  3.778  |  83.79  | 2.091e-18 |
# | **OA:Salinity:Temp** |  1  | 0.02514 | 0.02514 | 0.5576  |  0.4556   |
# |    **Residuals**     | 439 |  19.79  | 0.04508 |   NA    |    NA     |
shapiro.test(residuals(Age11Length_lm_mod)) # 1.24e-08
leveneTest(Age11Length_lm_mod) # < 2.2e-16 *** pass
boxplot(residuals(Age11Length_lm_mod) ~ Age11_raw_length$Temp*Age11_raw_length$OA*Age11_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age11Length_lm_mod)) # check for normality of residuals - looks okay




# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age11Length_lm_mod, pairwise~Salinity:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # Salinity Temp emmean   SE  df lower.CL upper.CL .group
 # High     Low     106 2.90 439    100.2      112  a    
 # Low      Low     110 3.65 439    102.3      117  a    
 # Low      High    114 9.54 439     94.9      132  a    
 # High     High    171 2.39 439    165.9      175   b   

# plot the data  ----------------------------------------------------------------------------------------------------- #


require(forcats)
Age11_ShellLength_Boxplot <- ggplot(data=Age11_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_bw() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 11 days", x ="pCO2 level", y = "Shell Length (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_age_11days_Boxplots.pdf", width=11, height=6)
print(Age11_ShellLength_Boxplot)
dev.off()

```


### Age 15 days ALL DATA  ------------

```{r, LENGTH Age 15 days hours size - all data}


# Age 15 Length mod - all data -------------------------------------------------------------------------------------- #

library(lme4)
library(lmerTest)
Age15Length_lme_mod <- lmer(length_um~OA*Salinity*Temp+(1|random_fact),na.action = na.exclude,data=Age15_raw_length)
anova(Age15Length_lme_mod)
# Type III Analysis of Variance Table with Satterthwaite's method
#                  Sum Sq Mean Sq NumDF   DenDF F value    Pr(>F)    
# OA                 9550    9550     1 10.3987  4.9471   0.04935 *  
# Salinity          19553   19553     1 10.5734 10.1289   0.00914 ** 
# Temp             161985  161985     1  9.6591 83.9116 4.516e-06 ***
# OA:Salinity          16      16     1 10.4108  0.0085   0.92828    
# OA:Temp            1355    1355     1  9.1807  0.7020   0.42340    
# Salinity:Temp     12445   12445     1  9.9323  6.4469   0.02955 *  
leveneTest(residuals(Age15Length_lme_mod) ~ Age15_raw_length$Temp*Age15_raw_length$OA*Age15_raw_length$Salinity) # < 2.2e-16 *** pass
boxplot(residuals(Age15Length_lme_mod) ~ Age15_raw_length$Temp*Age15_raw_length$OA*Age15_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age15Length_lme_mod)) # check for normality of residuals - looks okay
# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age15Length_lme_mod, pairwise~Salinity:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # Salinity Temp emmean   SE    df lower.CL upper.CL .group
 # High     Low     121 12.9  9.81     91.9      150  a    
 # Low      High    191 15.6 11.68    157.3      226   b   
 # High     High    275 10.3  8.98    252.1      299    c  
 # Low      Low  nonEst   NA    NA       NA       NA       


#  run model (lm)
Age15Length_lm_mod <- lm(length_um~OA*Salinity*Temp,data=Age15_raw_length)
shapiro.test(residuals(Age15Length_lm_mod)) # 0.18815
leveneTest(residuals(Age15Length_lm_mod) ~ Age15_raw_length$Temp*Age15_raw_length$OA*Age15_raw_length$Salinity) # 0.11596 pass
boxplot(residuals(Age15Length_lm_mod) ~ Age15_raw_length$Temp*Age15_raw_length$OA*Age15_raw_length$Salinity) # visual of residuals grouped
qqnorm(resid(Age15Length_lm_mod)) # check for normality of residuals - looks okay
# boxcox transformation
b      <- boxcox(Age15Length_lm_mod)
lambda <- b$x[which.max(b$y)]    
Age15_raw_length$length_um_boxcox <- (Age15_raw_length$length_um ^ lambda - 1) / lambda
Age15Length_lm_mod_boxcox <- lm(length_um_boxcox~OA*Salinity*Temp,data=Age15_raw_length)
pander(anova(Age15Length_lm_mod_boxcox), style='rmarkdown') # anova table of lmr
shapiro.test(residuals(Age15Length_lm_mod_boxcox)) # 0.0001068
leveneTest(Age15Length_lm_mod_boxcox) # 1.958e-14 ***






# post hoc tests --------------------------------------------------------------------------------------------------- #
posthoc<-emmeans(Age15Length_lm_mod, pairwise~OA:Salinity:Temp, adjust="tukey")
multcomp::cld(posthoc$emmeans,alpha = 0.5, Letters = letters)
 # OA   Salinity Temp emmean   SE  df lower.CL upper.CL .group
 # High Low      Low    72.5 1.30 3915     69.9     75.1  a    
 # High Low      High   73.2 1.57 3915     70.1     76.2  a    
 # High High     High   76.1 1.28 3915     73.6     78.6  a    
 # Low  Low      Low    80.9 1.07 3915     78.8     83.0   b   
 # Low  High     Low    83.2 1.11 3915     81.0     85.15   bc  
 # High High     Low    83.2 1.215 3915     80.8     85.7   bc  
 # Low  Low      High   85.5 1.16 3915     83.2     87.8    c  
 # Low  High     High   92.1 1.33 3915     89.5     915.7     d 

# plot the data  ----------------------------------------------------------------------------------------------------- #


require(forcats)
Age15_ShellLength_Boxplot <- ggplot(data=Age15_raw_length, aes(x=fct_relevel(OA, c("Low", "High")), 
                                                             y=length_um, 
                                                             colour=fct_relevel(Salinity, c("Low", "High")), 
                                                             linetype= Temp)) +
                              geom_boxplot() + 
                              theme_bw() +  
                              stat_summary(fun.y="mean",position = position_dodge2(width = 0.75)) +
                              theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
                              labs(title="Age = 15 days", x ="pCO2 level", y = "Shell Length (μm)")+ 
                              theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
                              theme(axis.text=element_text(size=12)) 

setwd("C:/Users/samjg/Documents/Github_repositories/Cvirginica_multistressor/RAnalysis")
pdf("Output/Length/Length_age_15days_Boxplots.pdf", width=15, height=6)
print(Age15_ShellLength_Boxplot)
dev.off()




# Age 15 Length mod - COLD TEMP EXCLUDED! -------------------------------------------------------------------------------------- #

Age15_raw_length_hightemp <- Age15_raw_length %>% dplyr::filter(Temp %in% 'High')
Age15Length_lme_mod_hightemp <- lmer(length_um~OA*Salinity+(1|random_fact),na.action = na.exclude,data=Age15_raw_length_hightemp)
leveneTest(residuals(Age15Length_lme_mod_hightemp) ~ Age15_raw_length_hightemp$Temp*Age15_raw_length_hightemp$OA*Age15_raw_length_hightemp$Salinity) # 0.002785 **

Age15Length_lm_mod_hightemp <- lm(length_um~OA*Salinity,data=Age15_raw_length_hightemp)
shapiro.test(residuals(Age15Length_lm_mod_hightemp)) # 0.001222
leveneTest(residuals(Age15Length_lm_mod_hightemp) ~ Age15_raw_length_hightemp$OA*Age15_raw_length_hightemp$Salinity) # 0.002785 **

# boxcox transformation
b      <- boxcox(Age15Length_lm_mod_hightemp)
lambda <- b$x[which.max(b$y)]    
Age15_raw_length_hightemp$length_um_boxcox <- (Age15_raw_length_hightemp$length_um ^ lambda - 1) / lambda
Age15Length_lm_mod_hightemp_boxcox <- lm(length_um_boxcox~OA*Salinity,data=Age15_raw_length_hightemp)
shapiro.test(residuals(Age15Length_lm_mod_hightemp_boxcox)) # 0.08641
leveneTest(Age15Length_lm_mod_hightemp_boxcox) 

pander(anova(Age15Length_lm_mod_hightemp_boxcox), style='rmarkdown') # anova table of lmr
# |     &nbsp;      | Df  |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)   |
# |:---------------:|:---:|:---------:|:---------:|:-------:|:---------:|
# |     **OA**      |  1  | 134512602 | 134512602 |  10.52  | 0.001372  |
# |  **Salinity**   |  1  | 814738781 | 814738781 |  63.69  | 8.612e-14 |
# | **OA:Salinity** |  1  |  141283   |  141283   | 0.01105 |  0.9164   |
# |  **Residuals**  | 215 | 2.75e+09  | 12791391  |   NA    |    NA     | 
qqnorm(resid(Age15Length_lm_mod_hightemp_boxcox)) # check for normality of residuals - looks okay



```


